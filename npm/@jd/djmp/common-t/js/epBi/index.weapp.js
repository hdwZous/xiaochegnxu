"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r,i=arguments[t];for(r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},_createClass=function(){function i(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),e}}(),_indexWeapp=require("../bi/index.weapp.js"),_indexWeapp2=require("../getApp/index.weapp.js"),_indexWeapp3=_interopRequireDefault(_indexWeapp2);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Exposure=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=arguments[1];_classCallCheck(this,r),this.self=t,this.selector=e,this.timer=[],this.data={},this.observer=null,this.history=[],this.otherParams={}}return _createClass(r,[{key:"_getHistoryPage",value:function(){try{return(0,_indexWeapp3.default)()._independent_.historyPage||[]}catch(e){throw e}}},{key:"_init",value:function(t){var r=this,e=(this.history=this._getHistoryPage(),this.observer=this.self.createIntersectionObserver({observeAll:!0}),this.observer.relativeToViewport().observe(this.selector,function(e){t(e)}),setInterval(function(){var e=Object.keys(r.data);e&&e.length&&r._reportExposureData(r.data)},1e3));this.timer.push(e)}},{key:"_dealExposureData",value:function(e){var t=this.data,r=e.dataset.userAction,e=e.intersectionRatio;r&&0<e&&(t[r]?t[r]+=1:t[r]=1)}},{key:"_reportExposureData",value:function(e){var t,r=e,i=[];for(t in r)i.push({spmId:t,cnt:r[t]});0<i.length&&((0,_indexWeapp.exposureReport)(_extends({ep:i,create_time:new Date},this.otherParams||{}),this.history),this.data={})}},{key:"initObserver",value:function(){var t=this,e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).otherParams;this.otherParams=e||{},this.disconnectObserver(),this._init(function(e){t._dealExposureData(e)})}},{key:"disconnectObserver",value:function(){this.data={},this.observer&&this.observer.disconnect(),this.timer&&this.timer.forEach(function(e){e&&clearInterval(e)})}},{key:"popReport",value:function(e){var t;Array.isArray(e)&&0<e.length?(t=e.map(function(e){return{spmId:e,cnt:1}}),(0,_indexWeapp.exposureReport)({ep:t,create_time:new Date},this.history)):(0,_indexWeapp.exposureReport)({ep:[{spmId:e,cnt:1}],create_time:new Date},this.history)}}]),r}();exports.default=Exposure;