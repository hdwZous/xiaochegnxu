"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function i(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,a){return t&&i(e.prototype,t),a&&i(e,a),e}}(),_get=function e(t,a,i){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,a);return void 0!==n?"value"in n?n.value:void 0!==(n=n.get)?n.call(i):void 0:null!==(n=Object.getPrototypeOf(t))?e(n,a,i):void 0},_index=require("../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_friendHelp=require("../api/friendHelp.js"),_indexWeapp2=require("../../../npm/@jd/djmp/common-t/js/share/index.weapp.js"),_indexWeapp3=require("../../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_indexWeapp4=require("../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_indexWeapp5=require("../../../npm/@jd/djmp/common-t/constants/index.weapp.js"),_indexWeapp6=require("../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_indexWeapp7=require("../../../npm/@jd/djmp/common-t/js/jump/index.weapp.js"),_utilsWeapp=require("../common/utils.weapp.js"),_indexWeapp8=require("../../../npm/@jd/djmp/common-t/js/storage/index.weapp.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var isWeapp=!0,Launch=(_temp2=_class=function(){function o(){var e,t;_classCallCheck(this,o);for(var a=arguments.length,i=Array(a),n=0;n<a;n++)i[n]=arguments[n];return(e=t=_possibleConstructorReturn(this,(t=o.__proto__||Object.getPrototypeOf(o)).call.apply(t,[this].concat(i)))).$usedState=["$compid__23","$compid__24","$compid__25","$compid__26","showDefault","style","result","ruleDesc","defaultType","defaultTips","showRulePop","showInvitePop","hasShowPop","firstJoinPage","firstShow","hasClickShare"],t.config={navigationBarTitleText:"京东到家",navigationBarBackgroundColor:"#fff",navigationBarTextStyle:"black",usingComponents:{"back-to-app":"/components/backToApp/index"}},t.customComponents=["Default","Marquee","InfoCard","Pop","SubscribeMessage"],_possibleConstructorReturn(t,e)}return _inherits(o,_index.Component),_createClass(o,[{key:"_constructor",value:function(e){var t=this;_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"_constructor",this).call(this,e),this.shareFlag=!0,this.state={ruleDesc:"",showDefault:!0,defaultType:0,defaultTips:"",showRulePop:!1,result:{},showInvitePop:!1,hasShowPop:!1,firstJoinPage:!1,firstShow:!0,hasClickShare:!1},this.$$refs=[{type:"component",id:"yEjDy",refName:"",fn:function(e){return t.childSubscribe=e}}]}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var e=this.$prefix,t=(0,_index.genCompid)(e+"$compid__23"),a=(0,_index.genCompid)(e+"$compid__24"),i=(0,_index.genCompid)(e+"$compid__25"),e=(0,_index.genCompid)(e+"$compid__26"),n=this.__state,o=(n.popType,n.showInvitePop,n.showStayPop,n.result),s=n.showDefault,r=n.defaultType,n=n.defaultTips;return s&&_index.propsManager.set({defaultType:r,defaultTips:n,onDefaultEvent:this.onDefaultEvent.bind(this)},t),!s&&o.wonList&&0<o.wonList.length&&_index.propsManager.set({data:o.wonList},a),s||_index.propsManager.set({data:o,type:"launch",onOpenShare:this.onInviteFriend.bind(this),onHelpFriend:this.onHelpFriendGetCoupon.bind(this),onRefreshPage:this.getFriendHelpDetailInfo.bind(this,!1)},i),s||_index.propsManager.set({isShow:this.__state.showRulePop,onPopEvent:this.onPopEvent.bind(this)},e),Object.assign(this.__state,{$compid__23:t,$compid__24:a,$compid__25:i,$compid__26:e,style:_indexModuleScssMap2.default}),this.__state}},{key:"componentDidShow",value:function(){(0,_indexWeapp4.pvReport)({create_time:new Date});var e=this.$router.params,t=getApp();e.business&&(t.globalData.qrcode.business=e.business),e.channel&&(t.globalData.qrcode.channel=e.channel),this.getFriendHelpDetailInfo()}},{key:"onShareAppMessage",value:function(e){this.afterSharePop();var t=this.state.result,a=t.activityId,i=t.groupId,n=t.sceneId,o=t.materialId,s=t.tempId,r=t.shareAb,r=void 0===r?{}:r,p=t.shareText,u=t.name,t=t.shareUrl,d="13";return{title:(void 0===p?"":p)||(void 0===u?"":u)||"来帮好友助力吧~",imageUrl:(void 0===t?"":t)||"",path:"/pages/friendHelp/detail/index?activityId="+(void 0===a?"":a)+"&groupId="+(void 0===i?"":i)+"&channel="+(d="button"==e.from?"14":d)+"&sceneId="+(void 0===n?"":n)+"&materialId="+(void 0===o?"":o)+"&tempId="+(void 0===s?"":s)+"&strategyName="+r.strategyName+"&experimentName="+r.experimentName}}},{key:"sleep",value:function(e){for(var t=new Date,a=t.getTime()+e;;)if((t=new Date).getTime()>a)return}},{key:"onClickShareSubscribe",value:function(e){this.sleep(1500);var t=[];try{t=(0,_indexWeapp8.getStorageSync)("cutShareInfo")}catch(e){}if(t){for(var a=!1,i=0;i<t.length;i++)if(t[i].activityId==e){a=!0;break}a||(t.push({activityId:e}),(0,_indexWeapp8.setStorageSync)("cutShareInfo",t),this.childSubscribe.initSubscribeMessage(["iwJcSNrbfOXKnfhoi4tEJvC1AnVWoNj1R8D8FSctMs0","3zzStxd9r5oOQ0N569D5l-cJ6OYj1E3QHb095rCRvSs","aUUy2JkJeivLJJCEPOMuM_fsywgjhNjdN4ryMeWYcsw"]))}else(t=[]).push({activityId:e}),(0,_indexWeapp8.setStorageSync)("cutShareInfo",t),this.childSubscribe.initSubscribeMessage(["iwJcSNrbfOXKnfhoi4tEJvC1AnVWoNj1R8D8FSctMs0","3zzStxd9r5oOQ0N569D5l-cJ6OYj1E3QHb095rCRvSs","aUUy2JkJeivLJJCEPOMuM_fsywgjhNjdN4ryMeWYcsw"])}},{key:"onDefaultEvent",value:function(){3===(this.state.defaultType||"")&&(this.getFriendHelpDetailInfo(),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"ClickLoadAgain"}))}},{key:"getFriendHelpDetailInfo",value:function(){var o=this,s=((0,_indexWeapp.showLoading)(),this.$router.params),r=1;s.groupId&&(r=2),(0,_indexWeapp6.isLogin)().then(function(){(0,_friendHelp.getFriendHelpDetail)({activityId:s.activityId||"",groupId:s.groupId||""}).then(function(e){(0,_indexWeapp.hideLoading)();var e=e.result||{},t=o.state.firstJoinPage,a=o.state.hasClickShare,i=e&&e.ruleDesc||"",n=0;e&&e.activityId?(3==e.helpStatus&&(0,_indexWeapp.showToast)({title:"规定时间内未助力成功"}),2==e.helpStatus&&e.toast&&(0,_indexWeapp.showToast)({title:e.toast}),1==e.helpStatus&&(!e.shareCount||t||a?(t=!0,o.firstJoinShowPop(e)):(t=!1,o.againJoinShowPop(e))),3===e.status&&(0,_indexWeapp.showToast)({title:"活动已结束"}),4===e.helpStatus&&(0,_indexWeapp.showToast)({title:"已抢光"}),o.setState({result:e,ruleDesc:i,showDefault:!1,firstJoinPage:t})):(n=1,o.setState({showDefault:!0,defaultType:2,defaultTips:"活动被挤爆啦，稍后再试哦～"})),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"pvReport",click_par:{type:r,is_default:n,activity_id:s.activityId||"",source:e.activityType||"",from:s.from,channel:s.channel,pushType:s.pushType,msgType:s.msgType,group_id:e.groupId||""}})}).catch(function(e){(0,_indexWeapp.hideLoading)(),o.setState({showDefault:!0,defaultType:3,defaultTips:e.msg||e.code?e.msg+"（"+e.code+"）":"暂未获取到助力券信息，稍后重试～"}),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"pvReport",click_par:{type:r,is_default:1,channel:s.channel,pushType:s.pushType,msgType:s.msgType}})})}).catch(function(){(0,_indexWeapp6.goToLogin)()})}},{key:"getPageType",value:function(e){var t,a;return e?(t=null,7==e.buttonId||8==e.buttonId?t="参与成功":2==e.helpStatus?t="助力成功":3==e.helpStatus?t="助力失败":3==e.status?t="活动已结束":4==e.status?t="券已抢光":1===e.failCause?t="参团失败1":2===e.failCause||3===e.failCause?t="参团失败2":(a=0,e.friendHelpUserVOList.map(function(e){e.nickName&&a++}),a==e.totalMemberNum&&(t="助力人数已满")),t):""}},{key:"onPopEvent",value:function(e){"close"===e.type&&this.setState({showRulePop:!1})}},{key:"onBackDealSelf",value:function(){this.goBack()}},{key:"onToggleRulePop",value:function(){this.setState({showRulePop:!0}),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"click_rule"})}},{key:"getCircleSharePic",value:function(e){(0,_indexWeapp.showLoading)()}},{key:"_throttle",value:function(e){var t=this;this.shareFlag&&(this.shareFlag=!1,e.apply(this,arguments),setTimeout(function(){t.shareFlag=!0},500))}},{key:"onClickShare",value:function(t){var a=this,i="https://storage.360buyimg.com/wximg/friendhelp/default_share_img.jpg",e=t.shareAb,n=void 0===e?{}:e,o=""+window.location.origin+window.location.pathname+"#/pages/sharePreview-t/index?image="+i+"&title=好友助力";this._throttle(function(){var e={djNewShare:1,appId:"gh_5103b94a8a56",title:t.shareText||t.name||"好友助力",mpImgUrl:t.shareUrl||"https://imgcps.jd.com/xappcms/image_37782570/image_37783007/image_37782570/IA/IA/IA/IA/IA/IA/t-5dca76a51439a4d971f5e4b9/75c75d51.jpg",path:"/pages/friendHelp/detail/index?activityId="+t.activityId+"&groupId="+t.groupId+"&channel="+a.taroShareCode().cardChannel+"&sceneId="+t.sceneId+"&materialId="+t.materialId+"&tempId="+t.tempId+"&strategyName="+n.strategyName+"&experimentName="+n.experimentName,imgUrl:t.shareUrl||"https://imgcps.jd.com/xappcms/image_37782570/image_37783007/image_37782570/IA/IA/IA/IA/IA/IA/t-5dca76a51439a4d971f5e4b9/75c75d51.jpg",desc:t.shareText||t.name||"",shareUrl:o,pyqImg:i,channel:"Wxfriends",callback:"",clickcallback:""};(0,_indexWeapp2.openShare)(e)})}},{key:"onClickPopBackground",value:function(){this.setState({showInvitePop:!1})}},{key:"onInviteFriend",value:function(){var e=this.state.result;this.onClickShareSubscribe(e.activityId),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"ClickInviteFriend",click_par:{is_layer:1,shareCount:e.shareCount,activity_id:e.activityId||""}})}},{key:"afterSharePop",value:function(){this.setState({showStayPop:!1,hasClickShare:!0}),this.addShareNum()}},{key:"taroShareCode",value:function(){var e="00",t="00",a={},t=_indexWeapp3.isJDApp?_indexWeapp3.isJDReactNativeWebView?(e="01","02"):(e="03","04"):_indexWeapp3.isDaojiaApp?_indexWeapp3.isIOS?(e="05","06"):(e="07","08"):_indexWeapp3.isWeixin?(e="09","10"):(e="11","12");return a.circleChannel=e,a.cardChannel=t,a}},{key:"onHelpFriendGetCoupon",value:function(t){var a=this,e=this.state.result,i=e.activityId||"",e=e.groupId||"",n=(0,_indexWeapp8.getStorageSync)(_indexWeapp5.LOGIN_INFO)||{},o=(0,_indexWeapp8.getStorageSync)("wxGroupId")||"",o=e+","+(n.openId||"")+","+o;(0,_friendHelp.LaunchOrJoinFriendHelp)({activityId:i,groupId:e,nickName:n.nickname,nickHeadUrl:n.avatar,openId:n.openId,wcUnionId:n.unionid_pdj_jd_new||"",encodeData:(0,_utilsWeapp.encrypt)(o)}).then(function(e){switch((0,_indexWeapp.hideLoading)(),a.setState({showInvitePop:!1}),e.code){case"0":(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"ClickSelf"}),"helpSelf"==t&&(0,_indexWeapp.showToast)({title:"恭喜你，成功给自己助力了一次"}),a.getFriendHelpDetailInfo(!1);break;case"50000":a.getFriendHelpDetailInfo(!1);break;case"70000":(0,_indexWeapp.showToast)({title:e.msg||"该助力活动已结束"});break;case"70001":(0,_indexWeapp.showToast)({title:e.msg||"参与活动次数已达上限"});break;case"70003":(0,_indexWeapp.showToast)({title:e.msg||"你已参与过该好友助力，去发起新的好友助力吧~"});break;case"70010":(0,_indexWeapp.showToast)({title:e.msg||"今日已抢光（明日抢）"});break;case"70006":(0,_indexWeapp.showToast)({title:e.msg||"活动已抢光（已抢光）"});break;case"202":(0,_indexWeapp6.goToLogin)();break;default:(0,_indexWeapp.showToast)({title:e.msg})}}).catch(function(e){(0,_indexWeapp.hideLoading)(),(0,_indexWeapp.showToast)({title:e.msg||"网络异常"}),a.setState({showInvitePop:!1}),a.getFriendHelpDetailInfo(!1)})}},{key:"firstJoinShowPop",value:function(e){var t=this,e=e||this.state.result,a=!1,i=this.state.firstShow,n=this.state.hasShowPop;e.totalMemberNum>e.firstLadderCount?e.shareCount?e.shareCount&&1<=e.selfJoinCount?e.totalMemberNum>e.secondLadderCount?e.shareCount-1>=e.shareGroupCount?e.totalMemberNum>e.thirdLadderCount?e.shareCount-1>e.shareGroupCount?!e.inviteFriendEnough||3==e.selfJoinCount?a=!0:(a=!1,_indexWeapp.showToast)({title:"自动助力异常，请关闭页面重新进入"}):e.shareCount-1==e.shareGroupCount&&(2==e.selfJoinCount?a=!0:(a=!1,_indexWeapp.showToast)({title:"自动助力异常，请关闭页面重新进入"})):2==e.selfJoinCount?a=e.shareCount-1==e.shareGroupCount:(a=!1,_indexWeapp.showToast)({title:"自动助力异常，请关闭页面重新进入"}):a=!0:a=1==e.shareCount:1==e.shareCount&&0==e.selfJoinCount&&(a=!1,_indexWeapp.showToast)({title:"自动助力异常，请关闭页面重新进入"}):a=!0:a=0==e.shareCount,(a||n)&&(n=!0),this.state.hasClickShare?setTimeout(function(){t.setState({showInvitePop:a,hasShowPop:n,firstShow:i})},2e3):this.setState({showInvitePop:a,hasShowPop:n,firstShow:i})}},{key:"againJoinShowPop",value:function(e){var t=e||this.state.result,a=!1,i=this.state.hasShowPop;t.totalMemberNum>t.firstLadderCount?1<=t.shareCount?a=t.selfJoinCount<1||t.totalMemberNum>t.secondLadderCount&&(t.shareCount-1==t.shareGroupCount&&t.selfJoinCount<2||!!(t.totalMemberNum>t.thirdLadderCount&&t.inviteFriendEnough)&&t.selfJoinCount<3):this.firstJoinShowPop(e):a=!1,this.setState({showInvitePop:a,hasShowPop:i=a||i?!0:i})}},{key:"addShareNum",value:function(){var a=this,i=this.state.result;(0,_friendHelp.countShareNum)({groupId:i.groupId,activityId:i.activityId}).then(function(e){var t=e.result;"0"==e.code&&(1==t.shareCount&&i.totalMemberNum>t.firstLadderCount||1==t.selfJoinCount&&t.shareCount-1>=t.shareGroupCount&&i.totalMemberNum>t.secondLadderCount||t.inviteFriendEnough&&2==t.selfJoinCount&&i.totalMemberNum>t.thirdLadderCount?a.delayHelpSelf():a.getFriendHelpDetailInfo())})}},{key:"delayHelpSelf",value:function(e){var t=this;setTimeout(function(){t.onHelpFriendGetCoupon(e)},3e3)}},{key:"goBack",value:function(){this.state.result;this.backPrePage()}},{key:"backPrePage",value:function(){(0,_indexWeapp7.jump)({to:"back"})}}]),o}(),_class.$$events=["onToggleRulePop"],_class.options={addGlobalClass:!0},_class.$$componentPath="pages/friendHelp/launch/index",_temp2);exports.default=Launch,Component(require("../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Launch,!0));