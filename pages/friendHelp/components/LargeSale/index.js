"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i,n=arguments[t];for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},_createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),_get=function e(t,i,n){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,i);return void 0!==a?"value"in a?a.value:void 0!==(a=a.get)?a.call(n):void 0:null!==(a=Object.getPrototypeOf(t))?e(a,i,n):void 0},_index=require("../../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../../../npm/@jd/djmp/common-t/js/utils/index.weapp.js"),_friendHelp=require("../../api/friendHelp.js"),_indexWeapp2=require("../../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_indexWeapp3=require("../../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap),_indexWeapp4=require("../../../../npm/@jd/djmp/common-t/js/share/index.weapp.js"),_indexWeapp5=require("../../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_indexWeapp6=require("../../../../npm/@jd/djmp/common-t/js/env/index.weapp.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}_temp2=_class=function(){function o(){var e,t;_classCallCheck(this,o);for(var i=arguments.length,n=Array(i),a=0;a<i;a++)n[a]=arguments[a];return(e=t=_possibleConstructorReturn(this,(t=o.__proto__||Object.getPrototypeOf(o)).call.apply(t,[this].concat(n)))).$usedState=["result","showHelpCoupon","anonymousState__temp","anonymousState__temp2","currentCoupon","currentPage","refreshFlag","type","updateData","refreshList"],t.customComponents=["SubscribeMessage","CountDown"],_possibleConstructorReturn(t,e)}return _inherits(o,_index.Component),_createClass(o,[{key:"_constructor",value:function(e){var t=this;_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"_constructor",this).call(this,e),this.state={currentCoupon:{},currentPage:0,refreshFlag:!1},this.isToPushSetting=!1,this.currentActivityId="",this.shareFlag=!0,this.shouldRequestRemind="",this.$$refs=[{type:"component",id:"UBuoE",refName:"",fn:function(e){return t.childSubscribe=e}}]}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var e=this.$prefix,t=this.__props,i=t.type,t=t.result,i=2==i,n=i?this._createHelpCouponBoxData(e+"nlACLkMMlz")():null,e=this._createCouponBoxData(e+"WXBSsgOIMe")();return Object.assign(this.__state,{result:t,showHelpCoupon:i,anonymousState__temp:n,anonymousState__temp2:e}),this.__state}},{key:"_createHelpCouponBoxData",value:function(n){var a=this;return function(){var e=a.state.currentPage,i=a.props.result||[];return a.anonymousFunc0=function(e){return a.onSwipeChange(e)},{loopArray57:i&&i.length?i.map(function(e,t){return e={$original:(0,_index.internal_get_original)(e)},{$loopState__temp4:i&&i.length?a._createHelpCouponMainData(n+"FrHXyUSncy"+t)(e.$original):null,$original:e.$original}}):[],loopArray58:i.map(function(e,t){return{$loopState__temp6:"dot"+t,$original:(e={$original:(0,_index.internal_get_original)(e)}).$original}}),style:_indexModuleScssMap2.default,currentPage:e,data:i}}}},{key:"_createHelpCouponMainData",value:function(a){return function(e){var t=(0,_index.genCompid)(a+"$compid__236"),i=e.totalMemberNum||0,i=Math.floor((i-e.leftMembers)/i*100)+"%",n=(e.helpStatus,e&&e.groupRemainTime&&0<e.groupRemainTime?{bg:"#4A4A4A",color:"#fff"}:null),i=(0,_index.internal_inline_style)({width:i});return e&&e.groupRemainTime&&0<e.groupRemainTime&&_index.propsManager.set({time:e.groupRemainTime,refreshFlag:e.groupRemainTime,cssDefined:!0,timeFormat:"hh-mm-ss",cssObj:n},t),{anonymousState__temp7:n,anonymousState__temp8:i,$compid__236:t,data:e,style:_indexModuleScssMap2.default}}}},{key:"onSwipeChange",value:function(e){e=e.detail.current;this.setState({currentPage:e})}},{key:"_createCouponBoxData",value:function(n){var a=this;return function(){var e=a.props.result||[],t=a.state.currentActiveIndex,i=a._createCouponMainData(n+"HvxqEGMPPV")();return{loopArray59:e.map(function(e,t){return{$loopState__temp11:"allData"+t,$original:(e={$original:(0,_index.internal_get_original)(e)}).$original}}),style:_indexModuleScssMap2.default,allData:e,currentActiveIndex:t,anonymousState__temp9:i,statusTxt:{1:"待开始",2:"已开始",3:"已结束",4:"已抢光",5:"抢购中"}}}}},{key:"_createCouponMainData",value:function(l){var u=this;return function(){var e=(0,_index.genCompid)(l+"$compid__237"),t=u.state.currentCoupon,i=t.totalMemberNum||0,n=t.leftMembers||0,n=Math.floor((i-n)/i*100)+"%",i=(t.helpStatus,1!==t.helpStatus&&1===t.secKillStatus||1!==t.helpStatus&&5===t.secKillStatus||1!==t.helpStatus&&2===t.secKillStatus||3!==t.secKillStatus&&t.secKillStatus,1===t.helpStatus),a=1!==t.helpStatus&&1===t.secKillStatus,o=1!==t.helpStatus&&2===t.secKillStatus||1!==t.helpStatus&&5===t.secKillStatus,r=1!==t.helpStatus&&3===t.secKillStatus,s=1!==t.helpStatus&&4===t.secKillStatus,p=t&&t.groupRemainTime&&0<t.groupRemainTime?{bg:"#fff",color:"#FF2D2D"}:null,n=i?(0,_index.internal_inline_style)({width:n}):null;return i&&t&&t.groupRemainTime&&0<t.groupRemainTime&&_index.propsManager.set({time:t.groupRemainTime,refreshFlag:t.groupRemainTime,cssDefined:!0,timeFormat:"hh-mm-ss",cssObj:p},e),{anonymousState__temp12:p,anonymousState__temp13:n,$compid__237:e,data:t,style:_indexModuleScssMap2.default,onSale:o,finishedFlag:r,robedFlag:s,willStart:a,showCutDownTime:i}}}},{key:"remindMe",value:function(e,t){t.stopPropagation(),(0,_indexWeapp2.clickReport)({create_time:new Date,click_id:"ClickFlashsaleGoods",click_par:{contentid:1,activity_id:e}});t=this.remindAPI.bind(this,e);this.childSubscribe.initSubscribeMessage(["K1HtLhViyzUMKbZjeFmR3AS2FLYmxF1ua8XaReShCt0"],15,t)}},{key:"hasOpenPushSettingHandle",value:function(e){(0,_indexWeapp.hasOpenPushSetting1)(this.handle1.bind(this,e))}},{key:"handle1",value:function(e,t){1==t?this.remindAPI(e,!0):0==t&&this.isToPushSetting&&(this.isToPushSetting=!1,this.shouldRequestRemind=!0,this.currentActivityId=e,(0,_indexWeapp.goOpenPushSetting)())}},{key:"remindAPI",value:function(e,t){var i,n,a=this;t&&(t=this.state,i=t.currentActiveIndex,n=t.currentCoupon,(0,_friendHelp.secKillSubscribeAPI)({activityId:e,type:0}).then(function(e){0==e.code?(n=_extends({},n,{remindFlag:1}),(0,_index.showToast)({title:"恭喜！设置成功\r\n将在开抢三分钟提醒"}),a.setState({currentCoupon:n}),a.props.updateData({index:i})):(0,_index.showToast)({title:"设置提醒失败"})}).catch(function(e){(0,_index.showToast)({title:e.msg})}))}},{key:"componentDidUpdate",value:function(){var e=this.state.refreshFlag,t=this.props,i=t.result,t=t.refreshList;if(i.length&&e!=t){for(var n=this.props.result,a=0,o=0;o<n.length;o++)if(n[o].isAnchor){a=o;break}this.setState({currentCoupon:n[a],currentActiveIndex:a,refreshFlag:t})}}},{key:"componentDidMount",value:function(){var e=this.currentActivityId,t=this.shouldRequestRemind;e&&t&&(this.shouldRequestRemind="",this.currentActivityId="",this.hasOpenPushSettingHandle(e))}},{key:"toUse",value:function(e){var e=e.couponGo||{},t=e.to||"",i=getApp().globalData.addressInfo;"store"==t?(0,_indexWeapp5.navigateTo)("/pages/store/index?storeId="+(e.storeId||"")+"&orgCode="+(e.orgCode||"")+"&longitude="+i.longitude+"&latitude="+i.latitude):"goodsList"==t?(0,_indexWeapp5.navigateTo)("/pages/purchTicket/purchTickets/purchTickets?stationNo="+(e.storeId||"")+"&orgCode="+(e.orgCode||"")+"&couponId="+(e.couponId||"")+"&longitude="+i.longitude+"&latitude="+i.latitude):"storeList"==t?(0,_indexWeapp5.navigateTo)("/pages/purchTicket/purchTicketsStoreList/storeList?promotionInfoId="+(e.couponId||"")+"&jumpType="+(e.jumpType||"")+"&longitude="+i.longitude+"&cityId="+i.cityId+"&latitude="+i.latitude):switchTab("/pages/home/home")}},{key:"taroShareCode",value:function(){var e="00",t="00",i={},t=_indexWeapp6.isJDApp?_indexWeapp6.isJDReactNativeWebView?(e="01","02"):(e="03","04"):_indexWeapp6.isDaojiaApp?_indexWeapp6.isIOS?(e="05","06"):(e="07","08"):_indexWeapp6.isWeixin?(e="09","10"):(e="11","12");return i.circleChannel=e,i.cardChannel=t,i}},{key:"clickTime",value:function(e){var t=this.props.result;this.setState({currentCoupon:t[e],currentActiveIndex:e})}},{key:"componentWillUnmount",value:function(){clearInterval(this.state.timer)}},{key:"onStopPropagation",value:function(e,t){t.stopPropagation(),this.props.onShareSubscribEvent(e.activityId)}},{key:"onClickBtn",value:function(e,t){t.stopPropagation();t=this.props.type;(0,_indexWeapp2.clickReport)({create_time:new Date,click_id:2==t?"ClickInvite":"ClickFlashsaleGoods",click_par:{is_start:e.status,contentid:3,activity_id:e.activityId||""}}),this.onClickShare(e)}},{key:"_throttle",value:function(e){var t=this;this.shareFlag&&(this.shareFlag=!1,e.apply(this,arguments),setTimeout(function(){t.shareFlag=!0},1e3))}},{key:"onClickShare",value:function(t){var i=this,n="https://storage.360buyimg.com/wximg/friendhelp/default_share_img.jpg",e=t.shareAb,a=void 0===e?{}:e,o=""+window.location.origin+window.location.pathname+"#/pages/sharePreview-t/index?image="+n+"&title=好友助力";this._throttle(function(){var e={djNewShare:1,appId:"gh_5103b94a8a56",title:t.shareText||t.name||"好友助力",mpImgUrl:t.shareUrl||"https://imgcps.jd.com/xappcms/image_37782570/image_37783007/image_37782570/IA/IA/IA/IA/IA/IA/t-5dca76a51439a4d971f5e4b9/75c75d51.jpg",path:"/pages/friendHelp/detail/index?activityId="+t.activityId+"&groupId="+t.groupId+"&channel="+i.taroShareCode().cardChannel+"&sceneId="+t.sceneId+"&materialId="+t.materialId+"&tempId="+t.tempId+"&strategyName="+a.strategyName+"&experimentName="+a.experimentName,imgUrl:t.shareUrl||"https://imgcps.jd.com/xappcms/image_37782570/image_37783007/image_37782570/IA/IA/IA/IA/IA/IA/t-5dca76a51439a4d971f5e4b9/75c75d51.jpg",desc:t.shareText||t.name||"",shareUrl:o,pyqImg:n,channel:"Wxfriends",callback:"",clickcallback:""};(0,_indexWeapp4.openShare)(e)})}},{key:"onClickCard",value:function(e,t){this.props.onClickCard(e,t)}},{key:"dealClickCard",value:function(i,e){var n=this;(0,_indexWeapp3.isLogin)().then(function(){(0,_indexWeapp5.showLoading)(),i.groupId?n.goToDetail(i):(0,_friendHelp.LaunchOrJoinFriendHelp)({activityId:i.activityId}).then(function(e){switch((0,_indexWeapp5.hideLoading)(),e.code){case"0":var t=e.result;t&&t.groupId?(t={activityId:i.activityId||"",groupId:t.groupId||""},n.goToDetail(t),(0,_indexWeapp2.clickReport)({create_time:new Date,click_id:"ClickLaunchNew",click_par:{activity_id:i.activityId||""}})):(0,_index.showToast)({title:e.msg||"发起次数达到上限"});break;case"70000":(0,_index.showToast)({title:e.msg||"该助力活动已结束"});break;case"70001":(0,_index.showToast)({title:e.msg||"参与活动次数已达上限~"});break;case"70003":(0,_index.showToast)({title:e.msg||"你已参与过该好友助力，去发起新的好友助力吧~"});break;case"70010":(0,_index.showToast)({title:e.msg||"今日已抢光（明日抢）"});break;case"70006":(0,_index.showToast)({title:e.msg||"活动已抢光（已抢光）"});break;case"202":(0,_indexWeapp3.goToLogin)({localTargetUrl:"/pages/friendHelp/list/index"});break;default:(0,_index.showToast)({title:e.msg||"网络错误"})}}).catch(function(e){(0,_indexWeapp5.hideLoading)(),(0,_index.showToast)({title:e.msg||"网络异常"})})}).catch(function(e){(0,_indexWeapp3.goToLogin)({localTargetUrl:"/pages/friendHelp/detail/index"})})}},{key:"goToDetail",value:function(e){e="/pages/friendHelp/launch/index?from=list&activityId="+e.activityId+"&groupId="+e.groupId;(0,_indexWeapp5.navigateTo)(e)}},{key:"componentWillUnmount",value:function(){this.currentActivityId="",this.shouldRequestRemind=""}},{key:"anonymousFunc0",value:function(e){}}]),o}(),_class.$$events=["anonymousFunc0","onStopPropagation","onClickCard","clickTime","onStopPropagation","remindMe","onClickCard"],_class.options={addGlobalClass:!0},_class.multipleSlots=!0,_class.$$componentPath="pages/friendHelp/components/LargeSale/index";var LargeSale=_temp2;exports.default=LargeSale,Component(require("../../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(LargeSale));