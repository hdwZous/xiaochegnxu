"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a,i=arguments[t];for(a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},_createClass=function(){function i(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,a){return t&&i(e.prototype,t),a&&i(e,a),e}}(),_get=function e(t,a,i){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,a);return void 0!==n?"value"in n?n.value:void 0!==(n=n.get)?n.call(i):void 0:null!==(n=Object.getPrototypeOf(t))?e(n,a,i):void 0},_index=require("../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_friendHelp=require("../api/friendHelp.js"),_indexWeapp=require("../../../npm/@jd/djmp/common-t/js/location/index.weapp.js"),_indexWeapp2=require("../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_indexWeapp3=require("../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_indexWeapp4=require("../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_indexWeapp5=require("../../../npm/@jd/djmp/common-t/js/jump/index.weapp.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap),_indexWeapp6=require("../../../npm/@jd/djmp/common-t/js/storage/index.weapp.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var startTime=Date.now(),isReportPerformance=!1,List=(_temp2=_class=function(){function s(){var e,t;_classCallCheck(this,s);for(var a=arguments.length,i=Array(a),n=0;n<a;n++)i[n]=arguments[n];return(e=t=_possibleConstructorReturn(this,(t=s.__proto__||Object.getPrototypeOf(s)).call.apply(t,[this].concat(i)))).$usedState=["anonymousState__temp","anonymousState__temp2","anonymousState__temp3","$compid__19","$compid__20","$compid__21","$compid__22","style","showDefault","largeSaleData","ruleDesc","address","list","currentPage","defaultType","defaultTips","defaultBtnTxt","showRulePop","loadingMore","refreshList","refreshFlag2","topType"],t.config={navigationBarTitleText:"京东到家",navigationBarBackgroundColor:"#fff",navigationBarTextStyle:"black"},t.customComponents=["LargeSale","Default","ListAll","Pop","SubscribeMessage"],_possibleConstructorReturn(t,e)}return _inherits(s,_index.Component),_createClass(s,[{key:"_constructor",value:function(e){var t=this;_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_constructor",this).call(this,e),this.userAction="",this.pvReportParams={},this.requestFlag=!0,this.shouldReportFalg=!0,this.flashsale=0,this.state={address:{},list:[],ruleDesc:"",currentPage:1,showDefault:!0,defaultType:0,defaultTips:"",defaultBtnTxt:"",showRulePop:!1,loadingMore:!0,refreshList:!0,refreshFlag2:!0,largeSaleData:[],topType:""},this.$$refs=[{type:"component",id:"yXQsZ",refName:"",fn:function(e){return t.childSubscribe=e}}]}},{key:"_createData",value:function(){var t=this,e=(this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{},this.$prefix),a=(0,_index.genCompid)(e+"$compid__19"),i=(0,_index.genCompid)(e+"$compid__20"),n=(0,_index.genCompid)(e+"$compid__21"),e=(0,_index.genCompid)(e+"$compid__22"),s=this.__state.list||[],o=this.__state,r=o.largeSaleData,l=o.topType,p=o.refreshFlag2,c=o.showDefault,o=(o.ruleDesc,(0,_index.internal_inline_style)({"background-image":c&&0==r.length?"":"url(https://storage.360buyimg.com/wximg/friendhelp/explain2.png)"})),p=(this.anonymousFunc0=function(e){return t.onClickRule(e)},this.anonymousFunc1=function(e){return t.toMyHelpList(e)},!p),u=!this.__state.refreshList;return _index.propsManager.set({result:r,type:l,refreshList:p,onShareSubscribEvent:this.onClickShareSubscribe.bind(this),onClickCard:this.onClickCard.bind(this),updateData:this.updateData.bind(this)},a),c&&_index.propsManager.set({defaultType:this.__state.defaultType,defaultTips:this.__state.defaultTips,defaultBtnTxt:this.__state.defaultBtnTxt,defaultTop:"0px",onDefaultEvent:this.onDefaultEvent.bind(this)},i),c||_index.propsManager.set({list:s,onClickCard:this.onClickCard.bind(this),onShareSubscribEvent:this.onClickShareSubscribe.bind(this),refreshList:u},n),_index.propsManager.set({isShow:this.__state.showRulePop,onPopEvent:this.onPopEvent.bind(this)},e),Object.assign(this.__state,{anonymousState__temp:o,anonymousState__temp2:p,anonymousState__temp3:u,$compid__19:a,$compid__20:i,$compid__21:n,$compid__22:e,style:_indexModuleScssMap2.default}),this.__state}},{key:"componentWillMount",value:function(){startTime=Date.now(),isReportPerformance=!0}},{key:"componentDidShow",value:function(){(0,_indexWeapp4.pvReport)({create_time:new Date});var e=this.$router.params,t=(e.userAction&&(this.userAction=decodeURIComponent(e.userAction)),this.pvReportParams={channel:e.channel,pushType:e.pushType,msgType:e.msgType},getApp());e.business&&(t.globalData.qrcode.business=e.business),e.channel&&(t.globalData.qrcode.channel=e.channel),this.handleListFn()}},{key:"handleListFn",value:function(){var t=this;Date.now();this.getLocationPromise().then(function(e){new Date;t.setState({address:e||{}},function(){t.handleLargeSaleInfo().then(function(){t.getFriendHelpList(1)}).catch(function(e){t.getFriendHelpList(1)})})}).catch(function(e){new Date;t.setState({showDefault:!0,defaultTips:e.msg||"未获取到地理位置",defaultType:1}),t.shouldReportFalg&&t.pvReportFn(1),t.shouldReportFalg=!1})}},{key:"sleep",value:function(e){for(var t=new Date,a=t.getTime()+e;;)if((t=new Date).getTime()>a)return}},{key:"onClickShareSubscribe",value:function(e){if(e){this.sleep(1500);var t=[];try{t=(0,_indexWeapp6.getStorageSync)("cutShareInfo")}catch(e){}if(t){for(var a=!1,i=0;i<t.length;i++)if(t[i].activityId==e){a=!0;break}a||(t.push({activityId:e}),(0,_indexWeapp6.setStorageSync)("cutShareInfo",t),this.childSubscribe.initSubscribeMessage(["iwJcSNrbfOXKnfhoi4tEJvC1AnVWoNj1R8D8FSctMs0","3zzStxd9r5oOQ0N569D5l-cJ6OYj1E3QHb095rCRvSs","aUUy2JkJeivLJJCEPOMuM_fsywgjhNjdN4ryMeWYcsw"]))}else(t=[]).push({activityId:e}),(0,_indexWeapp6.setStorageSync)("cutShareInfo",t),this.childSubscribe.initSubscribeMessage(["iwJcSNrbfOXKnfhoi4tEJvC1AnVWoNj1R8D8FSctMs0","3zzStxd9r5oOQ0N569D5l-cJ6OYj1E3QHb095rCRvSs","aUUy2JkJeivLJJCEPOMuM_fsywgjhNjdN4ryMeWYcsw"])}}},{key:"onShareAppMessage",value:function(e){var t,a,i,n,s,o,r,l,p,c;return"button"===e.from?(t=void 0===(t=(e=e.target.dataset.params).status)?"":t,a=void 0===(a=e.activityId)?"":a,i=void 0===(i=e.groupId)?"":i,n=void 0===(n=e.sceneId)?"":n,s=void 0===(s=e.materialId)?"":s,o=void 0===(o=e.tempId)?"":o,r=void 0===(r=e.shareText)?"":r,l=void 0===(l=e.name)?"":l,p=void 0===(p=e.shareUrl)?"":p,c=void 0===(c=e.imageUrl)?"":c,e=void 0===(e=e.shareAb)?{}:e,(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"ClickFlashsaleGoods",click_par:{is_start:t,contentid:3}}),{title:r||l||"来帮好友助力吧~",imageUrl:p||c||"",path:"/pages/friendHelp/detail/index?activityId="+a+"&groupId="+i+"&sceneId="+n+"&materialId="+s+"&tempId="+o+"&strategyName="+e.strategyName+"&experimentName="+e.experimentName}):{title:"好友助力",imageUrl:"http://img30.360buyimg.com/mobilecms/jfs/t1/22028/16/11520/82586/5c908517E4763ecde/2b7c152c69de9a2f.png",path:"/pages/friendHelp/list/index"}}},{key:"handleLargeSaleInfo",value:function(){var i=this,n=this.state.refreshFlag2;return new Promise(function(a,e){(0,_friendHelp.secKillListAPI)().then(function(e){var t=i.pvReportParams,e=e.result,e=void 0===e?{}:e;e&&e.type&&(i.pvReportParams=_extends({},t,{flashsale:e.type})),e.secKillResps&&0<e.secKillResps.length?i.flashsale=1:e.groupIngResps&&0<e.groupIngResps.length&&(i.flashsale=2),e&&1==e.type?i.setState({topType:e.type,refreshFlag2:!n,largeSaleData:e.secKillResps},function(){a(!0)}):e&&2==e.type?i.setState({topType:e.type,refreshFlag2:!n,largeSaleData:e.groupIngResps},function(){a(!0)}):a(!0)}).catch(function(e){a(!0)})})}},{key:"getLocationPromise",value:function(){return new Promise(function(t,a){(0,_indexWeapp.getLocation)().then(function(e){e.cityId=e.cityId||e.areaCode||e.cityCode||"",e.cityName=e.city||e.cityName||"",e?t(e):a(!1)}).catch(function(e){a(!1)})})}},{key:"updateData",value:function(e){var a=e.index,e=this.state.largeSaleData;this.setState({largeSaleData:e.map(function(e,t){return t==a?_extends({},e,{remindFlag:1}):e})})}},{key:"getFriendHelpList",value:function(s){var e,o,r,l,p=this;this.requestFlag&&this.state.loadingMore&&(this.requestFlag=!1,e=this.state,o=e.largeSaleData,e.abFlag,r=1,(0,_indexWeapp2.showLoading)(),l=Date.now(),(0,_friendHelp.getFriendHelpList)({currentPage:s,dataSize:10,latitude:this.state.address.latitude,longitude:this.state.address.longitude,cityId:this.state.address.cityId}).then(function(e){(0,_indexWeapp2.hideLoading)(),r=0,p.requestFlag=!0;var t=1===s?[]:p.state.list,e=e.result,a=e&&e.ruleDesc||"",e=e&&e.friendHelpVOList||[],i=p.state.refreshList,n=Date.now();0<e.length?(p.flashsale||(p.flashsale=3),p.setState({list:t.concat(e),ruleDesc:a||"",currentPage:++s,refreshList:!i,showDefault:!1},function(){var e,t;isReportPerformance&&((e=getApp()).reportPerformance(1012,t=n-l),t=Date.now()-startTime-t,e.reportPerformance(2003,t),isReportPerformance=!1)})):1===s?0==o.length?((0,_indexWeapp2.showToast)({title:"当前位置暂无普通助力活动，去首页逛逛吧～"}),p.setState({showDefault:!0,defaultTips:"当前位置暂无普通助力活动，去首页逛逛吧~",defaultBtnTxt:"首页逛逛",defaultType:2,list:[]}),r=1):(r=1,p.setState({showDefault:!0,defaultTips:"当前位置暂无更多其它普通助力活动了",defaultType:5,ruleDesc:a||"",list:[]})):p.setState({loadingMore:!1}),p.shouldReportFalg&&p.pvReportFn(r),p.shouldReportFalg=!1}).catch(function(e){(0,_indexWeapp2.hideLoading)(),p.requestFlag=!0,1===p.state.currentPage&&(p.setState({showDefault:!0,defaultTips:e.msg||"服务错误~",defaultType:3}),p.shouldReportFalg&&p.pvReportFn(r),p.shouldReportFalg=!1)}))}},{key:"toMyHelpList",value:function(){(0,_indexWeapp3.isLogin)().then(function(){(0,_indexWeapp2.navigateTo)("/pages/friendHelp/myList/index")}).catch(function(e){(0,_indexWeapp3.goToLogin)({localTargetUrl:"/pages/friendHelp/list/index"})}),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"ClickMyLaunchHelp"})}},{key:"pvReportFn",value:function(e){var t=this.$router.params,a={},a=t.business&&161==t?{userAction:this.userAction||"",flashsale:this.flashsale,is_default:e}:_extends({},this.pvReportParams,{userAction:this.userAction,flashsale:this.flashsale,is_default:e});(0,_indexWeapp4.clickReport)({click_id:"pvReport",click_par:a})}},{key:"onScrollToLower",value:function(){this.getFriendHelpList(this.state.currentPage)}},{key:"onClickRule",value:function(){this.setState({showRulePop:!0}),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"click_rule"})}},{key:"onPopEvent",value:function(e){"close"===e.type&&this.setState({showRulePop:!1})}},{key:"onDefaultEvent",value:function(){var e=this.state.defaultType;3===e||1===e?this.handleListFn():4===e?(0,_indexWeapp3.goToLogin)({localTargetUrl:"/pages/friendHelp/list/index?tab=1"}):2===e&&(0,_indexWeapp5.jump)({to:"home"})}},{key:"onClickCard",value:function(e,t){(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"largeSale"==t?"ClickFlashsaleGoods":"ClickActivityGoods",click_par:{status:e.helpStatus,contentid:2,activity_id:e.activityId||""}});t="largeSale"==t?e.secKillStatus:["list","help"].includes(t)?e.status:"";[2,5].includes(t)?this.dealClickCard(e):[1,3,4].includes(t)&&(0,_indexWeapp2.showToast)({title:{1:"活动暂未开始哦～",3:"活动已结束～",4:"优惠券已抢光～"}[t]})}},{key:"dealClickCard",value:function(a){var i=this;(0,_indexWeapp3.isLogin)().then(function(){(0,_indexWeapp2.showLoading)(),a.groupId?i.goToDetail(a):(0,_friendHelp.LaunchOrJoinFriendHelp)({activityId:a.activityId}).then(function(e){switch((0,_indexWeapp2.hideLoading)(),e.code){case"0":var t=e.result;t&&t.groupId?(t={activityId:a.activityId||"",groupId:t.groupId||""},i.goToDetail(t),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"ClickLaunchNew",click_par:{activity_id:a.activityId||""}})):(0,_indexWeapp2.showToast)({title:e.msg||"发起次数达到上限"});break;case"70000":(0,_indexWeapp2.showToast)({title:e.msg||"该助力活动已结束"});break;case"70001":(0,_indexWeapp2.showToast)({title:e.msg||"参与活动次数已达上限~"});break;case"70003":(0,_indexWeapp2.showToast)({title:e.msg||"你已参与过该好友助力，去发起新的好友助力吧~"});break;case"70010":(0,_indexWeapp2.showToast)({title:e.msg||"今日已抢光（明日抢）"});break;case"70006":(0,_indexWeapp2.showToast)({title:e.msg||"活动已抢光（已抢光）"});break;case"202":(0,_indexWeapp3.goToLogin)({localTargetUrl:"/pages/friendHelp/list/index"});break;default:(0,_indexWeapp2.showToast)({title:e.msg||"网络错误"})}}).catch(function(e){(0,_indexWeapp2.hideLoading)(),(0,_indexWeapp2.showToast)({title:e.msg||"网络异常"})})}).catch(function(e){(0,_indexWeapp3.goToLogin)({localTargetUrl:"/pages/friendHelp/list/index"})})}},{key:"goToDetail",value:function(e){e="/pages/friendHelp/launch/index?from=list&activityId="+e.activityId+"&groupId="+e.groupId;(0,_indexWeapp2.navigateTo)(e)}},{key:"anonymousFunc0",value:function(e){}},{key:"anonymousFunc1",value:function(e){}}]),s}(),_class.$$events=["onScrollToLower","anonymousFunc0","anonymousFunc1"],_class.options={addGlobalClass:!0},_class.$$componentPath="pages/friendHelp/list/index",_temp2);exports.default=List,Component(require("../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(List,!0));