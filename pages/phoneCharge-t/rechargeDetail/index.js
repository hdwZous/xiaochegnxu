"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},_createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),_get=function e(t,n,a){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);return void 0!==o?"value"in o?o.value:void 0!==(o=o.get)?o.call(a):void 0:null!==(o=Object.getPrototypeOf(t))?e(o,n,a):void 0},_index=require("../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_indexWeapp2=require("../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_indexWeapp3=require("../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_phoneCharge=require("../api/phoneCharge.js"),_indexWeapp4=require("../../../npm/@jd/djmp/common-t/constants/index.weapp.js"),_indexWeapp5=require("../../../npm/@jd/djmp/common-t/js/openPay/index.weapp.js"),_indexWeapp6=require("../../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_indexWeapp7=require("../../../npm/@jd/djmp/common-t/js/storage/index.weapp.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var scopeData={orderId:"",CHINA_MOBILE:"https://storage.360buyimg.com/wximg/phone-charge/CHINA_MOBILE.png",CHINA_UNICOM:"https://storage.360buyimg.com/wximg/phone-charge/CHINA_UNICOM.jpg",CHINA_TELECOM:"https://storage.360buyimg.com/wximg/phone-charge/CHINA_TELECOM.png",31e3:"status_wait",9e4:"status_end",20020:"status_refund",20021:"status_end",20040:"status_end",env:"",payType:"",timerTimeout:""},rechargeDetail=(_temp2=_class=function(){function r(){var e,t;_classCallCheck(this,r);for(var n=arguments.length,a=Array(n),o=0;o<n;o++)a[o]=arguments[o];return(e=t=_possibleConstructorReturn(this,(t=r.__proto__||Object.getPrototypeOf(r)).call.apply(t,[this].concat(a)))).$usedState=["isLoading","anonymousState__temp","showError","anonymousState__temp2","style","scopeData","result","statusColor","showTime","params","minute","second","timer","timesOver"],t.config={navigationBarTitleText:"充值详情"},t.customComponents=[],_possibleConstructorReturn(t,e)}return _inherits(r,_index.Component),_createClass(r,[{key:"_constructor",value:function(e){_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_constructor",this).call(this,e),this.state={params:{},result:{},minute:"00",second:"00",timer:null,isLoading:!0,timesOver:!0},this.$$refs=[]}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var e=this.$prefix,t=this.__state,n=t.result,a=t.isLoading,t=(t.timesOver,_indexModuleScssMap2.default[scopeData[n.orderStatus]]),o=this.initTime(n.orderTime),n="{}"==JSON.stringify(n),a=a?this._createLoadingData(e+"diWUaYOkiW")():null,e=n?this._createNullData(e+"ItxEBdsXSg")():null;return Object.assign(this.__state,{anonymousState__temp:a,showError:n,anonymousState__temp2:e,style:_indexModuleScssMap2.default,scopeData:scopeData,statusColor:t,showTime:o}),this.__state}},{key:"_createLoadingData",value:function(e){return function(){return{style:_indexModuleScssMap2.default}}}},{key:"componentWillUnmount",value:function(){(0,_indexWeapp7.setStorageSync)("phoneFromPage","phoneDetail")}},{key:"componentDidMount",value:function(){var t=this;this.setState({params:this.$router.params},function(){(0,_indexWeapp3.isLogin)().then(function(e){t.fetchData()}).catch(function(e){(0,_indexWeapp3.goToLogin)({localTargetUrl:"/pages/phoneCharge-t/rechargeDetail/index?orderId="+t.$router.params.orderId})})})}},{key:"componentDidShow",value:function(){(0,_indexWeapp7.setStorageSync)("phoneFromPage",""),scopeData.timerTimeout="",this.getDeviceInfo()}},{key:"componentDidUpdate",value:function(){}},{key:"fetchData",value:function(){var t=this,n=((0,_indexWeapp.showLoading)(),this.state.params.orderId);(0,_phoneCharge.rechargeOrderDetails)({orderId:n}).then(function(e){(0,_indexWeapp.hideLoading)(),(0,_indexWeapp2.pvReport)({create_time:new Date,page_par:{Orderid:n,OrderStatus:e.result.orderStatus}}),t.setState({result:e.result,isLoading:!1}),31e3==e.result.orderStatus&&(t.showCountDown(e.result.orderExpireTime),scopeData.timerTimeout||(scopeData.timerTimeout=setTimeout(function(){t.fetchData()},e.result.orderExpireTime+10)))}).catch(function(e){(0,_indexWeapp.hideLoading)(),t.setState({isLoading:!1}),(0,_indexWeapp.showToast)({title:e.msg})})}},{key:"rechargePaymentFn",value:function(){var n=this,a=scopeData.env,o=this.state.params.orderId,e=(0,_indexWeapp7.getStorageSync)(_indexWeapp4.LOGIN_INFO)||{};(0,_indexWeapp2.clickReport)({create_time:new Date,click_id:"clickPay",click_par:{Orderid:o}}),(0,_phoneCharge.rechargePayment)({orderId:o,payChannel:a,openId:e.openId}).then(function(e){var t={};0==e.code?(t="WECHAT"==a?{appid:e.result.wechatPayDTO.appId||"",timestamp:e.result.wechatPayDTO.timestamp||"",noncestr:e.result.wechatPayDTO.nonceStr||"",prepayid:e.result.wechatPayDTO.prepayId||"",signType:e.result.wechatPayDTO.signType||"",sign:e.result.wechatPayDTO.sign||""}:{url:e.result.paymentUrl},(0,_indexWeapp5.openPay)(t).then(function(e){(0,_indexWeapp.navigateTo)("/pages/phoneCharge-t/payResult/index?orderId="+o)}).catch(function(){n.fetchData()})):(0,_indexWeapp.showToast)({title:e.msg})}).catch(function(e){})}},{key:"initTime",value:function(e){var t;return e?(e=new Date(e)).getFullYear()+"-"+(t=(t=e.getMonth()+1)<10?"0"+t:t)+"-"+(t=(t=e.getDate())<10?"0"+t:t)+" "+(t=(t=e.getHours())<10?"0"+t:t)+":"+(t=(t=e.getMinutes())<10?"0"+t:t):""}},{key:"getDeviceInfo",value:function(){var e=0,t="weapp"===(t="weapp")?(e=1,"WECHAT"):_indexWeapp6.isJDApp?_indexWeapp6.isJDReactNativeWebView?(e=2,"JD_RN"):(e=4,"JD_H5"):_indexWeapp6.isDaojiaApp?(e=0,"APP"):(e=3,(0,_indexWeapp6.getH5InWeappFlag)()?"IN_WEAPP_H5":"H5");scopeData=_extends({},scopeData,{payType:e,env:t})}},{key:"_createNullData",value:function(e){var t=this;return function(){t.state.result;return{style:_indexModuleScssMap2.default}}}},{key:"goHome",value:function(){(0,_indexWeapp.navigateTo)("/pages/phoneCharge-t/index")}},{key:"showCountDown",value:function(e){var t=this;this.millisecondCountDown(e,function(e){t.setState({minute:e.minute,second:e.second,timer:e.timer})})}},{key:"millisecondCountDown",value:function(n,a){var o=setInterval(function(){var e=0,t=0;0<n&&(e=Math.floor(n/1e3/60%60),t=Math.floor(n/1e3%60)),e<=9&&(e="0"+e),t<=9&&(t="0"+t),a(0<n?{minute:e,second:t,timer:o,end:!1}:{minute:"00",second:"00",timer:o,end:!0}),n-=1e3},1e3)}}]),r}(),_class.$$events=["rechargePaymentFn","goHome"],_class.multipleSlots=!0,_class.$$componentPath="pages/phoneCharge-t/rechargeDetail/index",_temp2);exports.default=rechargeDetail,Component(require("../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(rechargeDetail,!0));