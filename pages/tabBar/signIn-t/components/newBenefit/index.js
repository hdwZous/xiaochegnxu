"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var i=t,o=[],n=!0,t=!1,a=void 0;try{for(var s,r=e[Symbol.iterator]();!(n=(s=r.next()).done)&&(o.push(s.value),!i||o.length!==i);n=!0);}catch(e){t=!0,a=e}finally{try{!n&&r.return&&r.return()}finally{if(t)throw a}}return o}throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function o(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,i){return t&&o(e.prototype,t),i&&o(e,i),e}}(),_get=function e(t,i,o){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);return void 0!==n?"value"in n?n.value:void 0!==(n=n.get)?n.call(o):void 0:null!==(n=Object.getPrototypeOf(t))?e(n,i,o):void 0},_index=require("../../../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_indexWeapp2=require("../../../../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_beansExchange=require("../../../../../common-mp/api/beansExchange.js"),_signIn=require("../../../../../common-mp/api/signIn.js"),_indexWeapp3=require("../../../../../npm/@jd/djmp/common-t/js/location/index.weapp.js"),_indexWeapp4=require("../../../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_utils=require("../../../../../common-mp/components/TaskListForSignNew/js/utils.js"),_indexWeapp5=require("../../../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_goToByCouponWeapp=require("../../../../../npm/@jd/djmp/common-t/js/utils/goToByCoupon.weapp.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var guideFlag=!1,REPORT={keyName:{exchange:"clickSignPageNewExchangeBtn"},exchangeClick:function(e){var t=e.couponResponse,t=void 0===t?{}:t,e=e.couponType,i=t.couponTitle||t.counponTitle||"",e=e||t.couponType||1;(0,_indexWeapp4.clickReport)({click_id:this.keyName.exchange,click_par:{status:"马上抢",couponName:i,type:{1:"优惠券",2:"通用红包",3:"话费券",4:"唯一券码"}[e]}})}},itemForGuideUse=null,isWeapp=!0,NewBenefit=(_temp2=_class=function(){function a(){var e,t;_classCallCheck(this,a);for(var i=arguments.length,o=Array(i),n=0;n<i;n++)o[n]=arguments[n];return(e=t=_possibleConstructorReturn(this,(t=a.__proto__||Object.getPrototypeOf(a)).call.apply(t,[this].concat(o)))).$usedState=["NewUserBenefit","loopArray40","$compid__226","$compid__227","style","expandNum","exchangData","showExchangeSuccess","showComfireDialog","productDetail","address","cityId","signInInfo","v34abflag","callToBottomList","taskListRef","getNewUserBenefitLists","statusAction","popData"],t.config={navigationBarTitleText:""},t.customComponents=["ExchangeLayerForSignIn","ExchangeDetailForSignIn"],_possibleConstructorReturn(t,e)}return _inherits(a,_index.Component),_createClass(a,[{key:"_constructor",value:function(e){_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"_constructor",this).call(this,e),this.state={exchangData:{},showExchangeSuccess:!1,showComfireDialog:!1,productDetail:{},NewUserBenefit:{},address:{},cityId:"",expandNum:4},this.$$refs=[]}},{key:"toExchangeDetail",value:function(e){var t,i,o,n,a,s;0==e.type?(n=(a=e.skuResponse).skuId,t=a.storeId,a=a.orgCode,s=e.activityId,i=e.prizeId,o=e.userAction,(0,_indexWeapp.navigateTo)("/pages/beansExchange-t/exchangeDetail/index?storeId="+(t||"")+"&skuId="+(n||"")+"&orgCode="+(a||"")+"&configId="+((t=void 0===s?"":s)||"")+"&prizeId="+((void 0===i?"":i)||"")+"&activityId="+t+"&type=new&userAction="+(void 0===o?"":o))):(n=e.activityId,a=e.prizeId,s=e.userAction,(0,_indexWeapp.navigateTo)("/pages/beansExchange-t/exchangeDetail/index?activityId="+(void 0===n?"":n)+"&type=new&prizeId="+((void 0===a?"":a)||"")+"&userAction="+(void 0===s?"":s))),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"ClickNew",click_par:{}})}},{key:"BtnEvent",value:function(e){1==e?(this.setState({showComfireDialog:!1}),this.setGuideBeanShareLayer()):this.exchangePro()}},{key:"toMyExchangeList",value:function(){this.props.signInInfo(),this.setState({showExchangeSuccess:!1}),this.setState({showExchangeSuccess:!1});var e,t=this.props.v34abflag;"bottom"==t?(void 0===(e=(t=void 0===(t=this.state.exchangData)?{}:t).couponResponse)?{}:e).ifFull?this.props&&this.props.callToBottomList&&this.props.callToBottomList():this.goToCouponPage(t):(0,_utils.jumpExchange)()}},{key:"goToCouponPage",value:function(e){var t=this.state.address,i=t.longitude,o=t.latitude,t=t.cityId||t.areaCode||t.cityCode||"",n={};n.couponId=e.couponId||e.couponCode||e.couponResponse.couponCode,n.longitude=i,n.latitude=o,n.cityId=t,(0,_goToByCouponWeapp.goToByCouponId)(n)}},{key:"onPopEvent",value:function(){this.setState({showExchangeSuccess:!1})}},{key:"setCdKeyByExchange",value:function(e){var t;e&&(t=e.couponType,e=e.cdKey,4==t&&e&&(t=Object.assign({},this.state.productDetail,{cdKey:e}),this.setState({productDetail:t})))}},{key:"exchangePro",value:function(){var t=this,e={};e.activityId=this.state.exchangData.activityId||"",e.prizeId=this.state.exchangData.prizeId||"",e.type=this.state.exchangData.type||"",e.configId=""|this.state.exchangData.activityId,0==e.type&&(e.skuId=this.state.exchangData.skuResponse.skuId||"",e.storeId=this.state.exchangData.skuResponse.storeId||"",e.orgCode=this.state.exchangData.skuResponse.orgCode||""),(0,_beansExchange.exchangeProduct)({configId:e.activityId||"",activityId:e.activityId||"",skuId:e.skuId||"",storeId:e.storeId||"",orgCode:e.orgCode||"",type:"new",prizeId:e.prizeId||""}).then(function(e){0==e.code&&(t.setState({showComfireDialog:!1}),(0,_indexWeapp.showToast)({title:"兑换成功"}),setTimeout(function(){t.toMyExchangeList()},500),t.setCdKeyByExchange(e.result)),setTimeout(function(){t.getListInfo("",t.state.address),t.props.taskListRef()},500)}).catch(function(e){(0,_indexWeapp.showToast)({title:e.msg||"网络错误，请稍后重试！"}),t.setState({showComfireDialog:!1})})}},{key:"exchangeEvent",value:function(e){var t=e.type,i={};0==(void 0===t?0:t)?(i.activityId=e.activityId||"",i.skuId=e.skuResponse.skuId||"",i.storeId=e.skuResponse.storeId||"",i.orgCode=e.skuResponse.orgCode||"",i.type="new",i.configId=e.activityId||""):(i.configId=e.activityId||"",i.activityId=e.activityId||"",i.type="new"),i.prizeId=e.prizeId||"",this.getExchangeDetail(i),this.setRenderDataForPop(e),this.setState({showComfireDialog:!0}),this.setState({exchangData:e}),REPORT.exchangeClick(e)}},{key:"more",value:function(){this.setState({expandNum:this.state.NewUserBenefit.items.length}),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"clickShowAllNew",click_par:{}})}},{key:"getExchangeDetail",value:function(e){var t=this;(0,_beansExchange.exchangeDetail)({configId:e.configId||"",skuId:e.skuId||"",storeId:e.storeId||"",orgCode:e.orgCode||"",type:e.type||"",activityId:e.activityId||"",prizeId:e.prizeId||""}).then(function(e){0==e.code?t.setState({productDetail:e.result}):(0,_indexWeapp.showToast)({title:e.msg||"网络错误，请稍后重试！"})}).catch(function(e){(0,_indexWeapp.showToast)({title:e.msg||"网络错误，请稍后重试！"})})}},{key:"getListInfo",value:function(e,t){var i=this,t=t||this.state.address,o=this;(0,_signIn.getNewUserPrizeList)({cityId:t.cityId||t.areaCode||t.cityCode||"",platform:4,longitude:t.longitude,latitude:t.latitude,source:"H5",activityId:e}).then(function(e){0==e.code&&(o.setState({NewUserBenefit:i.setNumForList(e.result)||[]}),i.props.getNewUserBenefitLists(e.result||{}))}).catch(function(){})}},{key:"getLocaltionInfo",value:function(){var t=this;(0,_indexWeapp3.getLocation)().then(function(e){e.cityId=e.cityId||e.areaCode||e.cityCode||"",e.cityName=e.city||e.cityName||"",t.setState({address:e||{}}),setTimeout(function(){t.getListInfo("",e)},20)}).catch(function(){})}},{key:"refreshNewBenefit",value:function(e){var t=this;setTimeout(function(){t.getListInfo("",e)},20)}},{key:"getPosition",value:function(){var s=this;var e,t,i=this;function r(){i.props.statusAction("Guide",{guideIndex:-1})}this.getNewBenfitFlag()?(e=function(e){var t=0,i=e.length;if(e&&i){for(var o=0;o<i;o++){var n=e[o];if(1==n.buttonId){t=o,itemForGuideUse=n;break}}return t}}(void 0===(e=this.state.NewUserBenefit.items)?[]:e),(t=_index2.default.createSelectorQuery().in(this.$scope)).select("#newBeneft"+e).boundingClientRect(),t.selectViewport().scrollOffset(),t.exec(function(e){var t,i,o,n,e=_slicedToArray(e,2),a=e[0],e=e[1];a&&e?(t=a.left,i=a.top,0==(e=void 0===(e=e.scrollTop)?0:e)&&isWeapp&&_indexWeapp2.isAndroid&&window&&window.scrollY&&(e=window.scrollY),o=a.width,n={lefts:void 0===t?0:t,top:e+(void 0===i?0:i),width:o,height:a.height},setTimeout(function(){s.props.statusAction({position:n})})):r()})):r()}},{key:"getNewBenfitFlag",value:function(){var e=this.state.NewUserBenefit;return!!e&&!(!(e=e.items)||!e.length)}},{key:"exchangeEventByGuideOpe",value:function(){itemForGuideUse&&this.exchangeEvent(itemForGuideUse),guideFlag=!0}},{key:"setGuideBeanShareLayer",value:function(){guideFlag&&(this.props.statusAction("Guide",{guideIndex:4}),guideFlag=!1)}},{key:"setRenderDataForPop",value:function(e){this.setState({popData:e})}},{key:"componentDidMount",value:function(){}},{key:"getNumForList",value:function(){for(var e=this.state.NewUserBenefit.items,t=void 0===e?[]:e,i=0,o=0;o<t.length;o++)-1!=t[o].isShow&&++i;return i}},{key:"setNumForList",value:function(e){for(var t=e.items,i=0;i<t.length;i++)-1==t[i].isShow&&t.splice(i,1);return e}},{key:"toMyExchange",value:function(){(0,_indexWeapp5.isLogin)().then(function(e){(0,_utils.jumpExchange)(),(0,_indexWeapp4.clickReport)({create_time:new Date,click_id:"ClickExchange",click_par:{}})}).catch(function(e){(0,_indexWeapp5.goToLogin)()})}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var e=this.$prefix,t=(0,_index.genCompid)(e+"$compid__226"),e=(0,_index.genCompid)(e+"$compid__227"),i=this.__state,o=i.productDetail,o=void 0===o?{}:o,n=i.NewUserBenefit,n=void 0===n?{}:n,a=i.expandNum,i=n&&n.items&&0<n.items.length?n.items.map(function(e,t){return e={$original:(0,_index.internal_get_original)(e)},{$loopState__temp2:t<a&&-1!=e.$original.isShow?t+"Before":null,$loopState__temp4:t<a?t+"After":null,$loopState__temp6:1==e.$original.buttonId?(0,_index.internal_inline_style)({width:e.$original.progressRate+"%"}):null,$loopState__temp8:3==e.$original.buttonId?(0,_index.internal_inline_style)({width:e.$original.progressRate+"%"}):null,$original:e.$original}}):[];return _index.propsManager.set({showComfireDialog:this.__state.showComfireDialog,popData:this.__state.popData,onClickPop:this.onPopEvent.bind(this),onClickPopBtn:this.BtnEvent.bind(this)},t),_index.propsManager.set({showExchangeSuccess:this.__state.showExchangeSuccess,productDetail:o,onClickPop:this.onPopEvent.bind(this),onClickMyExchangeList:this.toMyExchangeList.bind(this)},e),Object.assign(this.__state,{loopArray40:i,$compid__226:t,$compid__227:e,style:_indexModuleScssMap2.default}),this.__state}}]),a}(),_class.$$events=["toMyExchange","toExchangeDetail","exchangeEvent","more"],_class.$$componentPath="pages/tabBar/signIn-t/components/newBenefit/index",_temp2);exports.default=NewBenefit,Component(require("../../../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(NewBenefit));