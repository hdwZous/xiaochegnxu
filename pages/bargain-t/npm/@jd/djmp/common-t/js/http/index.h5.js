"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.request=void 0;var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,i=arguments[t];for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_index=require("../../../../../@tarojs/taro-h5/dist/index.js"),_index2=_interopRequireDefault(_index),_indexH=require("../storage/index.h5.js"),_indexH2=require("../../constants/index.h5.js"),_indexH3=require("../utils/index.h5.js"),_indexH4=require("../env/index.h5.js"),_aesUtils=require("../utils/aes.utils.js"),_indexH5=require("../cookie/index.h5.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var now=Date.now(),decryptFail=!1,baseUrl="/client?_jdrandom="+now;function getChannel(){var e="h5";return _indexH4.isDaojiaApp?(_indexH4.isIOS&&(e="ios"),_indexH4.isAndroid&&(e="android")):_indexH4.isJDReactNativeWebView&&(e="rn"),e}console.log("process.env.NODE_ENV----------------","production");var request=exports.request=function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=(0,_indexH3.getDeviceId)();_indexH4.isJDApp&&(e||(console.error("我没有获取到deviceId需要重新设置"),(0,_indexH5.setCookie)(_indexH2.PDJ_H5_DEVICEID_KEY,_indexH4.jdDeviceId),e=_indexH4.jdDeviceId));var t=(0,_indexH.getStorageSync)(_indexH2.ADDRESS_INFO),t=("string"==typeof t?JSON.parse(t):t)||{};r.body&&"object"===_typeof(r.body)&&(r.body=JSON.stringify(r.body));e={lat:t.latitude||"",lng:t.longitude||"",lat_pos:t.latitude||"",lng_pos:t.longitude||"",city_id:t.cityId||t.areaCode||t.cityCode||"",channel:getChannel(),platform:"8.11.0",platCode:"h5",appVersion:"8.12.5",appName:"paidaojia",deviceModel:"appmodel",traceId:e+now||"",deviceToken:e,deviceId:e,_jdrandom:now};return(r=_extends({},e,r)).signkey&&(delete r.signkey,r.signKeyV1=(0,_indexH3.genSignKeyV1)(r)),decryptFail?(console.error("网关降级传输1"),new Promise(function(n,i){var o=Date.now();_index2.default.request({method:r.method||"GET",url:baseUrl+"&functionId="+r.functionId,data:r,credentials:"include",header:{"content-type":"application/x-www-form-urlencoded;"}}).then(function(e){var t=Date.now(),e=e.data||{};e.apiTime=t-o,(e.abTest||e.result&&e.result.abTest)&&(0,_indexH3.updateAb)(e.abTest),(r.isNeedDealError||0==e.code?n:i)(e)}).catch(function(e){i(e)})})):new Promise(function(n,i){var o=Date.now();_index2.default.request({method:r.method||"GET",url:baseUrl+"&functionId="+r.functionId,data:{djencrypt:(0,_aesUtils.encrypt)(JSON.stringify(r))},credentials:"include",header:{"content-type":"application/x-www-form-urlencoded;"}}).then(function(e){var t=Date.now(),e=e.data||{};"110"==e.code&&1==e.type?(decryptFail=!0,console.error("网关降级传输2"),_index2.default.request({method:r.method||"GET",url:baseUrl+"&functionId="+r.functionId,data:r,credentials:"include",header:{"content-type":"application/x-www-form-urlencoded;"}}).then(function(e){var t=Date.now(),e=e.data||{};e.apiTime=t-o,(e.abTest||e.result&&e.result.abTest)&&(0,_indexH3.updateAb)(e.abTest),(r.isNeedDealError||0==e.code?n:i)(e)}).catch(function(e){i(e)})):(e.apiTime=t-o,(e.abTest||e.result&&e.result.abTest)&&(0,_indexH3.updateAb)(e.abTest),(r.isNeedDealError||0==e.code?n:i)(e))}).catch(function(e){i(e)})})};