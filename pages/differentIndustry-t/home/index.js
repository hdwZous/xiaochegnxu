"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o,n=arguments[t];for(o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},_createClass=function(){function n(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}}(),_get=function e(t,o,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,o);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(n):void 0:null!==(i=Object.getPrototypeOf(t))?e(i,o,n):void 0},_index=require("../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_indexWeapp2=require("../../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap),_indexWeapp3=require("../../../npm/@jd/djmp/common-t/js/jump/index.weapp.js"),_indexWeapp4=require("../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_differentIndustry=require("../api/differentIndustry.js"),_indexWeapp5=require("../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_indexWeapp6=require("../../../npm/@jd/djmp/common-t/js/location/index.weapp.js"),_indexWeapp7=require("../../../npm/@jd/djmp/common-t/js/storage/index.weapp.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var isWeapp=!0,isInWeappH5=(0,_indexWeapp2.getH5InWeappFlag)(),scopeData={throttleFlag:!0,cityId:"",lng:"",lat:""},secTopPos=0,secList3Pos=0,screenHeight=_index2.default.getSystemInfoSync().screenHeight,currentScrollPos=0,ERROR={type:"",message:""},app=_index2.default.getApp(),urlParams="",Index=(_temp2=_class=function(){function a(){var e,t;_classCallCheck(this,a);for(var o=arguments.length,n=Array(o),i=0;i<o;i++)n[i]=arguments[i];return(e=t=_possibleConstructorReturn(this,(t=a.__proto__||Object.getPrototypeOf(a)).call.apply(t,[this].concat(n)))).$usedState=["$compid__176","showDefault","anonymousState__temp","phone","defineSelf","data","showResultTxt","defaultType","defaultTips","sendNewUserCoupon","isNewUser","toastConfigLogo","toastJumpLink","couponBaseInfo","firstOrder","buttionId","couponBaseInfoList","takeCouponRecordList","isShowDownButton","loginStatus"],t.config={navigationBarTitleText:"到家会员免费送"},t.getPaySource=function(){return(_indexWeapp2.isWeixin?"isWeixin":_indexWeapp2.isDaojiaApp&&"isDaojiaApp")||_indexWeapp2.isJDReactNativeWebView&&"isJDReactNativeWebView"||"isMiniProgram"},t.customComponents=["Default","WebpIMG","SecKillGoods"],_possibleConstructorReturn(t,e)}return _inherits(a,_index.Component),_createClass(a,[{key:"_constructor",value:function(e){var t=this;_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"_constructor",this).call(this,e),this.state={phone:"",defineSelf:!0,data:{},showResultTxt:!1,showDefault:!0,defaultType:0,defaultTips:"",sendNewUserCoupon:!1,isNewUser:!1,toastConfigLogo:"",toastJumpLink:"",couponBaseInfo:{},firstOrder:"",buttionId:"",couponBaseInfoList:[],takeCouponRecordList:[],isShowDownButton:!1,loginStatus:!1},this.hasPostCoupon=!1,this.$$refs=[{type:"component",id:"oyBlz",refName:"",fn:function(e){return t.childSecGoodsKill=e}}]}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var e=this.$prefix,t=(0,_index.genCompid)(e+"$compid__176"),o=this.__state,n=o.showDefault,i=o.defaultType,o=o.defaultTips,e=this._createMainData(e+"sSQoQJWzNr")();return n&&_index.propsManager.set({defaultType:i,defaultTips:o},t),Object.assign(this.__state,{$compid__176:t,anonymousState__temp:e}),this.__state}},{key:"_createMainData",value:function(g){var f=this;return function(){var e=(0,_index.genCompid)(g+"$compid__177"),t=(0,_index.genCompid)(g+"$compid__178"),o=f.state,n=o.bannelLogo,i=o.vipLogo,a=o.title,s=o.buttionId,p=o.phone,r=o.couponBaseInfoList,r=void 0===r?[]:r,c=o.takeCouponRecordList,c=void 0===c?[]:c,l=o.isShowDownButton,o=o.loginStatus,o=void 0!==o&&o,d=scopeData,u=d.lng,d=d.lat,h=f.state.secIsTop,_=0<r.length?r.map(function(e,t){return 1!=(e={$original:(0,_index.internal_get_original)(e)}).$original.takeType&&e.$original.takeType,{$original:e.$original}}):[],m=0<c.length?c.map(function(e,t){return 1!=(e={$original:(0,_index.internal_get_original)(e)}).$original.takeType&&e.$original.takeType,{$original:e.$original}}):[];return _index.propsManager.set({mode:"widthFix",className:_indexModuleScssMap2.default.banner,src:n,styletxt:{width:"100%"}},e),o&&u&&d&&_index.propsManager.set({isTop:h,setSecTopPos:f.setSecTopPos.bind(f),setSecList3Pos:f.setSecList3Pos.bind(f),secKillInfo:f.secKillInfoCallback.bind(f),handleSecTabChangeScroll:f.handleSecTabChangeScroll.bind(f),handleShowSecTaskSidebar:f.handleShowSecTaskSidebar.bind(f),handleSecKillLoading:f.handleSecKillLoading.bind(f),getCurrentScrollPos:f.getCurrentScrollPos.bind(f)},t),{loopArray31:_,loopArray32:m,$compid__177:e,$compid__178:t,buttionId:s,couponBaseInfoList:r,title:a,isShowDownButton:l,style:_indexModuleScssMap2.default,phone:p,takeCouponRecordList:c,loginStatus:o,lng:u,lat:d,vipLogo:i}}}},{key:"componentDidMount",value:function(){app.globalData.qrcode.business=this.$router.params.business||"",app.globalData.qrcode.channel=this.$router.params.channel||"",app.globalData._hasJump=!1}},{key:"componentDidShow",value:function(){this.dealFetchData()}},{key:"dealFetchData",value:function(){var s=this,t=this.$router.params.channel;this.judageIsLogin().then(function(){s.setState({loginStatus:!0}),s.getPositionController().then(function(a){s.fetchData(a).then(function(e){var t,o,n,i;e.isJump?(t=app.globalData._hasJump||!1)?(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"hasJump",click_par:_extends({},e,a)}):(app.globalData._hasJump=!0,s.goToStore(_extends({},e,a)),o=void 0===(o=e.storeId)?"":o,n=void 0===(n=e.orgCode)?"":n,i=void 0===(i=e.isH5)?"":i,(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"autoJump",click_par:_extends({storeId:o,orgCode:n,isH5:i},a,{hasJump:t})})):(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"nostorejump",click_par:_extends({},a)}),s.hasPostCoupon||s.getCoupon(_extends({},e,a))}).catch(function(e){})}).catch(function(e){s.setState({loginStatus:!0}),s.fetchData(),(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"noPoiJump",click_par:{channel:t}})})}).catch(function(e){s.fetchData(),(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"noLoginJump",click_par:{channel:t}})})}},{key:"dealOpenApp",value:function(){var e=this,t=this.$router.params,o=(t.channel,t.jumprule),t=t.openapp;if(1!=o&&3!=o||_indexWeapp2.isDaojiaApp)this.dealFetchData();else{var n,i="";for(n in this.$router.params)"openapp"!=n&&"jumprule"!=n&&(i=i+"&"+n+"="+this.$router.params[n]);i=i.substr(1),o=window.location.origin+"/taroh5/h5dist/#/pages/differentIndustry-t/home/index?"+i;try{0!=t&&(window.location.href="openApp.jddj://communication?body="+encodeURIComponent(JSON.stringify({params:{url:o},to:"web"})))}catch(e){}setTimeout(function(){e.dealFetchData()},1e4)}}},{key:"download",value:function(e){var t=this.$router.params,o=t.channel;t.jumprule,t.openapp;"isDownBtn"==e&&(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"clickdownloadbutton",click_par:{channel:o}}),(0,_indexWeapp3.jump)({to:"home",params:{channel:o,channel_name:o||""}})}},{key:"goHome",value:function(e){var t=this.$router.params,o=t.channel;t.jumprule,t.openapp;(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"clickgojddjbutton",click_par:{channel:o,statusId:e}}),isInWeappH5?(0,_indexWeapp3.jump)({to:"home",type:"h5",params:{}}):(0,_indexWeapp3.jump)({to:"home",params:{channel:o,channel_name:o||""}})}},{key:"toUse",value:function(){var e=this.$router.params,t=e.channel;e.openapp,e.jumprule;(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"clickgojddjbutton",click_par:{channel:t,statusId:1}}),_indexWeapp2.isDaojiaApp,(0,_indexWeapp3.jump)({to:"home",params:{channel:t,channel_name:t||""}})}},{key:"getCouponFn",value:function(){var t=this,e=this.state,o=e.vpId,n=e.buttionId,e=e.showResultTxt,i=this.$router.params.channel;1!=n||e?this.goHome(1):((0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"clickcooperatepage",click_par:{channel:i}}),this._throttle(function(){t.judageIsLogin().then(function(e){t.setState({loginStatus:!0}),t.getPositionController().then(function(e){t.hasPostCoupon||t.getCoupon(_extends({vpId:o},e,{isClick:"true"}))})}).catch(function(e){t.setState({loginStatus:!1}),t._goToLogin()})}))}},{key:"collectNum",value:function(e){var t=e.lat,t=void 0===t?"":t,e=e.lng,e=void 0===e?"":e,o=this.$router.params,n=o.channel,i=void 0===n?"":n,n=o.edisonid,a=void 0===n?"":n,n=o.fromid,s=void 0===n?"":n,n=o.pin,o=void 0===n?"":n,n=(0,_indexWeapp7.getStorageSync)("login_info")||{},p={activityId:a,channelCode:i,businessType:1,stressTest:!1,fromId:s,longitude:e,latitude:t};p.pin=o||n.PDJ_H5_PIN||"",(0,_differentIndustry.collectCPSNum)(p).then(function(e){(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"getedison",click_par:{channel:i,fromid:s,pin:p.pin,edisonid:a}})}).catch(function(e){})}},{key:"getCoupon",value:function(){var l=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this.$router.params,o=t.edisonid,n=t.fromid,d=t.channel;(0,_indexWeapp4.showLoading)();try{var i,a=e.isClick,u=void 0!==a&&a,s=e.vpId,p=e.lat,r=void 0===p?"":p,c=e.lng,h=void 0===c?"":c,_=e.cityId,m=void 0===_?"":_,g=this.getPaySource(),f={channel:d,vpId:s,redPacketPaySource:{isWeixin:96,isDaojiaApp:95,isJDReactNativeWebView:108,isJDApp:114,isMiniProgram:107,isDJBrowser:-1}[g],lat:r,lng:h};m&&(f=_extends({},f,{cityId:m})),"yili"==d&&(i=((0,_index.getApp)().globalData||{}).redeemCode||"",f=_extends({redeemCode:i},f)),(0,_differentIndustry.freeTakeFn)(f).then(function(e){var t,o,n,i,a,s,p,r,c;e=e||{},(0,_indexWeapp4.hideLoading)(),405==e.code||406==e.code?((0,_indexWeapp4.showToast)({title:e.msg}),c="",t=void 0,e.result&&(c=e.result.phone,t=e.result&&e.result.isShowDownButton||0),l.setState({title:e.msg,buttionId:0,phone:c||"",isShowDownButton:1==t})):0==e.code?(t=(c=e.result).title,o=c.buttionId,n=c.isNewUser,i=c.toastConfigLogo,a=c.toastJumpLink,s=c.phone,p=c.couponBaseInfo,r=c.couponBaseInfoList,c=c.isShowDownButton,l.setState({title:t,phone:s,buttionId:o,showResultTxt:!0,isNewUser:1==n,toastConfigLogo:i,toastJumpLink:a,couponBaseInfo:p,couponBaseInfoList:r||[],isShowDownButton:1==c}),l.hasPostCoupon=!0,1==c?(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"showdownloadbutton",click_par:{channel:d}}):0==o&&(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"showgojddjbutton",click_par:{channel:d}})):201==e.code||202==e.code?l._goToLogin():(e.result&&e.result.title&&l.setState({title:e.result.title,buttionId:0,isShowDownButton:1==e.result.isShowDownButton}),(0,_indexWeapp4.showToast)({title:e.msg})),l.clickRp("clickbutton",{channel:d,isClick:u||!1,code:e.code,info:e.msg||"",buttonId:e.result&&e.result.buttonId||""})}).catch(function(e){(0,_indexWeapp4.hideLoading)(),l.clickRp("clickbutton",{channel:d,info:e&&e.msg,isClick:u||!1})})}catch(e){}try{o&&n&&this.collectNum(e)}catch(e){}}},{key:"clickRp",value:function(e,t){(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:e,click_par:t})}},{key:"_throttle",value:function(e,t){scopeData.throttleFlag&&(scopeData.throttleFlag=!1,e.apply(this,arguments),setTimeout(function(){scopeData.throttleFlag=!0},t||1e3))}},{key:"fetchData",value:function(){var _=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};try{return new Promise(function(d,u){(0,_indexWeapp4.showLoading)();var h=_.$router.params.channel,e={channel:h};t&&(e=_extends({channel:h},t)),(0,_differentIndustry.getData)(e).then(function(e){var t,o,n,i,a,s,p,r,c,l;e=e||{},(0,_indexWeapp4.hideLoading)(),0==e.code?(t=(l=e.result).bannelLogo,o=l.vipLogo,n=l.title,i=l.buttionId,a=l.vpId,s=l.sendNewUserCoupon,p=l.firstOrder,r=l.takeCouponRecordList,c=l.phone,l=l.isShowDownButton,_.setState({bannelLogo:t,vipLogo:o,title:n,buttionId:i,vpId:a,phone:c||"",showDefault:!1,sendNewUserCoupon:s,firstOrder:1==p,takeCouponRecordList:(void 0===r?[]:r)||[],isShowDownButton:1==l}),1==l?(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"showdownloadbutton",click_par:{channel:h}}):0==i&&(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"showgojddjbutton",click_par:{channel:h}}),1==i&&(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"showbutton",click_par:{channel:h}})):_.setState({showDefault:!0,defaultType:2,defaultTips:"抱歉活动不存在"}),_.pvReportFn({code:e.code,buttionId:e.result&&e.result.buttionId||""}),e.result?d(e.result):u(e.msg)}).catch(function(e){(0,_indexWeapp4.hideLoading)(),_.setState({showDefault:!0,defaultType:2,defaultTips:"抱歉活动不存在"}),_.pvReportFn({code:-1,info:"抱歉活动不存在"}),u(e)})})}catch(e){}}},{key:"pvReportFn",value:function(e){var t=this.$router.params,o=t.channel,t=t.jumprule,t=void 0===t?"":t;(0,_indexWeapp5.pvReport)({create_time:new Date,page_par:_extends({channel:o,jumprule:t},e)})}},{key:"judageIsLogin",value:function(){return new Promise(function(e,t){(0,_indexWeapp.isLogin)().then(function(){e(!0)}).catch(function(){isInWeappH5||_indexWeapp2.isJDReactNativeWebView||_indexWeapp2.isJDApp||_indexWeapp2.isJDFinanceApp||_indexWeapp2.isJxApp||_indexWeapp2.isJiSuApp?(0,_indexWeapp.isLoginInWeappH5)().then(function(){e(!0)}).catch(function(){ERROR.type="login",ERROR.message="未登录",t(ERROR)}):(ERROR.type="login",ERROR.message="未登录",t(ERROR))})})}},{key:"_goToLogin",value:function(){var e=this.$router.params.channel,t=this.state.sendNewUserCoupon;(0,_indexWeapp.goToLogin)({channel:1==t?"vipcooperation_"+e:"",localTargetUrl:"/pages/differentIndustry-t/home/index?"+urlParams})}},{key:"getPositionController",value:function(){var o=this,e=scopeData,n=e.cityId,i=e.lng,a=e.lat;return new Promise(function(t,e){n&&i&&a?t({cityId:n,lng:i,lat:a}):(0,_indexWeapp6.getLocation)().then(function(e){o.clickRp("spclAddrSuccess");e={cityId:e.cityId||e.areaCode,lng:e.longitude,lat:e.latitude};scopeData=_extends({},scopeData,e),t(e)}).catch(function(){ERROR.type="location",ERROR.message="获取位置失败",e(ERROR)})})}},{key:"onShareAppMessage",value:function(){return{title:"京东到家",path:"/pages/home/home",imageUrl:"https://storage.360buyimg.com/wximg/common/logo.jpg"}}},{key:"onShareTimeline",value:function(){return{title:"京东到家",path:"/pages/home/home",imageUrl:"https://storage.360buyimg.com/wximg/common/logo.jpg"}}},{key:"goToStore",value:function(e){var t=e.storeId,o=e.orgCode,n=e.isH5,i=e.lat,e=e.lng,a=this.$router.params,s=a.channel,p=a.popup,r=a.second;a.jumprule,a.openapp;(0,_indexWeapp3.jump)({type:1==n?"h5":"",to:"store",params:{storeId:t,orgCode:o,addCart:!1,needAddCar:!1,needAddCart:0,isAddCart:!1,needAnchorSku:!0,latitude:void 0===i?"":i,longitude:void 0===e?"":e,channel:s,popup:void 0===p?"":p,second:void 0===r?"":r,channel_name:s||""}})}},{key:"toStoreInApp",value:function(e){var t=e.storeId,o=e.orgCode,n=e.needAnchorSku,i=e.addCart,a=e.needAddCar,s=e.userAction,p=e.isH5,r=e.lat,c=void 0===r?"":r,r=e.lng,l=void 0===r?"":r,e=this.$router.params,d=e.channel,r=e.popup,u=void 0===r?"":r,r=e.second,h=void 0===r?"":r,r=(e.jumprule,{params:{storeId:t,orgCode:o,cartType:0,needAnchorSku:n||!1,addCart:i||!1,needAddCar:a||!1,userAction:s||""},to:"store"});try{window.location.href="openApp.jddj://communication?body="+encodeURIComponent(JSON.stringify(r))}catch(e){}setTimeout(function(){_indexWeapp2.isDaojiaApp||(0,_indexWeapp3.jump)({type:1==p?"h5":"",to:"store",params:{storeId:t,orgCode:o,addCart:!1,needAddCar:!1,needAddCart:0,isAddCart:!1,needAnchorSku:!0,latitude:c,longitude:l,channel:d,popup:u,second:h,channel_name:d||""}})},1e3)}},{key:"getCurrentScrollPos",value:function(){return currentScrollPos}},{key:"onPageScroll",value:function(e){currentScrollPos=e.scrollTop;e=e.scrollTop>=secTopPos;0!=secTopPos&&this.state.secIsTop!=e&&0!=secTopPos&&this.setState({secIsTop:e})}},{key:"setSecTopPos",value:function(e){secTopPos=e+currentScrollPos}},{key:"secKillInfoCallback",value:function(e){this.setState({secKillProIsNull:e})}},{key:"handleSecTabChangeScroll",value:function(){this.childSecGoodsKill&&this.childSecGoodsKill.handleSecTabChangeScroll()}},{key:"handleShowSecTaskSidebar",value:function(e){this.setState({isShowSecTaskSidebar:e})}},{key:"handleSecKillLoading",value:function(e){this.setState({loadingForSecKill:e})}},{key:"setSecList3Pos",value:function(e){secList3Pos=0==e?e:e+currentScrollPos-screenHeight}}]),a}(),_class.$$events=["getCouponFn","download","goHome","toUse"],_class.multipleSlots=!0,_class.$$componentPath="pages/differentIndustry-t/home/index",_temp2);exports.default=Index,Component(require("../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Index,!0));