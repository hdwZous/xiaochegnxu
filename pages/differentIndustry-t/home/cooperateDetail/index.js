"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}(),_get=function e(t,n,o){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,n);return void 0!==a?"value"in a?a.value:void 0!==(a=a.get)?a.call(o):void 0:null!==(a=Object.getPrototypeOf(t))?e(a,n,o):void 0},_index=require("../../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_indexWeapp2=require("../../../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap),_indexWeapp3=require("../../../../npm/@jd/djmp/common-t/js/jump/index.weapp.js"),_indexWeapp4=require("../../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_differentIndustry=require("../../api/differentIndustry.js"),_indexWeapp5=require("../../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_indexWeapp6=require("../../../../npm/@jd/djmp/common-t/js/location/index.weapp.js"),_indexWeapp7=require("../../../../npm/@jd/djmp/common-t/js/utils/index.weapp.js"),_goToByCouponWeapp=require("../../../../npm/@jd/djmp/common-t/js/utils/goToByCoupon.weapp.js"),_indexWeapp8=require("../../../../npm/@jd/djmp/common-t/js/http/index.weapp.js"),_indexWeapp9=require("../../../../npm/@jd/djmp/common-t/js/storage/index.weapp.js"),_common=require("../../../../common-mp/api/common.js"),_commonData=require("../../api/commonData.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(i,s){return function t(e,n){try{var o=r[e](n),a=o.value}catch(e){return void s(e)}if(!o.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});i(a)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var isInWeappH5=(0,_indexWeapp2.getH5InWeappFlag)(),scopeData={jumpType:"",tempObj:"",loginToken:""},secTopPos=0,secList3Pos=0,screenHeight=_index2.default.getSystemInfoSync().screenHeight,currentScrollPos=0,ERROR={type:"",message:""},isWeapp=!0,app=_index2.default.getApp(),urlParams="",timer="",isSuccessToMini=!0,hasJumpMini=!1,Index=(_temp2=_class=function(){function i(){var e,t;_classCallCheck(this,i);for(var n=arguments.length,o=Array(n),a=0;a<n;a++)o[a]=arguments[a];return(e=t=_possibleConstructorReturn(this,(t=i.__proto__||Object.getPrototypeOf(i)).call.apply(t,[this].concat(o)))).$usedState=["$compid__184","showDefault","anonymousState__temp","loginStatus","defaultType","defaultTips","couponBaseInfoList","minute","second","timer","vipLogo","showSeckill","lng","lat","toastShow","toastVersion","toastUpdateTime","showWarning","lastTime"],t.config={navigationBarTitleText:"京东到家好礼免费送"},t.customComponents=["Default","NearbyShop","SecKillGoods"],_possibleConstructorReturn(t,e)}var e,t,n,o;return _inherits(i,_index.Component),_createClass(i,[{key:"_constructor",value:function(e){var t=this;_get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"_constructor",this).call(this,e),this.state={loginStatus:!1,showDefault:!0,defaultType:0,defaultTips:"",couponBaseInfoList:[],minute:"-",second:"-",timer:null,vipLogo:"",showSeckill:!1,lng:"",lat:"",toastShow:!1,toastVersion:"1",toastUpdateTime:"",showWarning:!1,lastTime:3},this.$$refs=[{type:"component",id:"NxyAR",refName:"",fn:function(e){return t.childSecGoodsKill=e}}]}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var e=this.$prefix,t=(0,_index.genCompid)(e+"$compid__184"),n=this.__state,o=n.showDefault,a=n.defaultType,i=n.defaultTips,n=n.functionName,n=void 0===n?"":n,e=this._createMainData(e+"NrIYlrwqTu")();return this.anonymousFunc0=n,o&&_index.propsManager.set({defaultType:a,onDefaultEvent:this.anonymousFunc0,defaultTips:i},t),Object.assign(this.__state,{$compid__184:t,anonymousState__temp:e}),this.__state}},{key:"_createMainData",value:function(l){var d=this;return function(){var e=(0,_index.genCompid)(l+"$compid__185"),t=(0,_index.genCompid)(l+"$compid__186"),n=d.state,o=n.loginStatus,o=void 0!==o&&o,a=n.couponBaseInfoList,i=n.secIsTop,s=n.vipLogo,r=n.lng,p=n.lat,n=(n.showWarning,n.lastTime,2<=a.length?2:a.length),a=1==n?d._create1CouponData(l+"BkrokGDYka")():null,u=n?null:d._createNoCouponData(l+"MMXfsODAty")(),c=o&&r&&p?{color:"#fff",bg:"#CD0606"}:null;return r&&p&&_index.propsManager.set({fromAutoJump:!0,loginStatus:o,lng:r,lat:p},e),o&&r&&p&&_index.propsManager.set({defineStyle:c,fromAutoJump:!0,isTop:i,setSecTopPos:d.setSecTopPos.bind(d),setSecList3Pos:d.setSecList3Pos.bind(d),secKillInfo:d.secKillInfoCallback.bind(d),handleSecTabChangeScroll:d.handleSecTabChangeScroll.bind(d),handleShowSecTaskSidebar:d.handleShowSecTaskSidebar.bind(d),handleSecKillLoading:d.handleSecKillLoading.bind(d),getCurrentScrollPos:d.getCurrentScrollPos.bind(d)},t),{anonymousState__temp4:c,$compid__185:e,$compid__186:t,loginStatus:o,style:_indexModuleScssMap2.default,show:n,anonymousState__temp2:a,anonymousState__temp3:u,lng:r,lat:p,vipLogo:s}}}},{key:"_create1CouponData",value:function(e){var i=this;return function(){var e=i.state,t=e.minute,n=e.second,o=e.couponBaseInfoList,e=e.loginStatus,o=o[0],a=2==o.couponType?"无门槛":3==o.couponType||4==o.couponType?"免运券":"";return{style:_indexModuleScssMap2.default,list:o,couponTypeName:a,loginStatus:e,noShowexpire:"00"==t&&"00"==n,minute:t,second:n}}}},{key:"_createNoCouponData",value:function(e){return function(){return{style:_indexModuleScssMap2.default}}}},{key:"cutDown",value:function(){var t=this;(0,_indexWeapp7.countDown)(9e5,function(e){e.end?(clearInterval(t.state.timer),t.setState({minute:"00",second:"00",timer:null})):t.setState({minute:e.minute,second:e.second,timer:e.timer})})}},{key:"componentDidMount",value:function(){app.globalData.qrcode.business=this.$router.params.business||"",app.globalData.qrcode.channel=this.$router.params.channel||"",app.globalData._hasJump=!1}},{key:"componentDidShow",value:(o=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,o,a,i,s,r,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=this.$router.params,a.gotomp,t=a.loginToken,n=a.o2o_m_h5_sid,n=void 0===n?"":n,o=a.PDJ_H5_JDPIN,o=void 0===o?"":o,a=a.PDJ_H5_PIN,a=void 0===a?"":a,(0,_commonData.setParamData)(this.$router.params),this.pvReportFn(),i=!1,e.prev=5,e.next=8,this.judageIsLogin();case 8:i=e.sent,e.next=14;break;case 11:e.prev=11,e.t0=e.catch(5),i=!1;case 14:if(i)e.next=38;else{if(t)return e.next=18,this.toThrouthMiniLogin();e.next=31}break;case 18:if(0==(s=e.sent).code)return r=s.result,e.next=23,(0,_common.getNewOpenId)();e.next=28;break;case 23:r.openId=e.sent,app.globalData.loginStateInfo=r,wx.setStorageSync("login_info",r),e.next=29;break;case 28:case 29:e.next=38;break;case 31:if(n)return p={o2o_m_h5_sid:n,PDJ_H5_JDPIN:o,PDJ_H5_PIN:a},e.next=35,(0,_common.getNewOpenId)();e.next=38;break;case 35:p.openId=e.sent,app.globalData.loginStateInfo=p,wx.setStorageSync("login_info",p);case 38:this.dealFetchData(!1),this.getLocationFn().then(function(e){e.from="yy_xcx",app.globalData.addressInfo=e,app.globalData.refreshHomeFlag=!0,app.saveAddress(e)});case 40:case"end":return e.stop()}},e,this,[[5,11]])})),function(){return o.apply(this,arguments)})},{key:"componentWillUnmount",value:function(){clearInterval(this.state.timer),this.setState({timer:null})}},{key:"dealFetchData",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,o,a,i,s,r,p=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.$router.params,n=i.edisonid,o=i.fromid,i.hasJumpMini,i=this.state,a=i.loginStatus,i=i.lng,this.fetchCouponData(),s={},i){e.next=10;break}return Date.now(),e.next=8,this.getLocationFn();case 8:s=e.sent,Date.now();case 10:if(r=!!a,a){e.next=23;break}return e.prev=12,Date.now(),e.next=16,this.judageIsLogin();case 16:r=e.sent,Date.now(),e.next=23;break;case 20:e.prev=20,e.t0=e.catch(12),r=!1;case 23:r&&this.fetchStroeData(s),n&&o&&this.collectNum(s),setTimeout(function(){p.setState({showSeckill:!0})},500);case 26:case"end":return e.stop()}},e,this,[[12,20]])})),function(e){return n.apply(this,arguments)})},{key:"dealOpenmini",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.$router.params.askpop,o="",t)return e.next=5,this.getLoginToken();e.next=7;break;case 5:0==(o=e.sent).code&&(scopeData.loginToken=o.result);case 7:1==n?this.startShowAlert():this.toJumpMini();case 8:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"toJumpMini",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"getLocationFn",value:function(){var n=this;return new Promise(function(t){(0,_indexWeapp6.getLocation)().then(function(e){e={cityId:e.cityId||e.areaCode,lng:e.longitude,lat:e.latitude};n.setState(_extends({},e)),t(e)}).catch(function(){t({})})})}},{key:"fetchCouponData",value:function(){var o=this;try{(0,_indexWeapp4.showLoading)();var e=this.$router.params,t=e.channel,n=void 0===t?"":t,a=e.strategyCode,i=void 0===a?"":a,s=(e.business,e.popupCoupon),r=void 0===s?"":s,p=(e.channelBusiness,{channel:n,strategyCode:i,popupCoupon:r});(0,_differentIndustry.commonTakeCoupon)(p).then(function(){var e,t,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};(0,_indexWeapp4.hideLoading)(),0==n.code?(t=(e=n.result).couponBaseInfoList,e=e.vipLogo,2<(t=(t=void 0===t?[]:t)||[]).length&&(t=t.splice(0,1)),o.setState({showDefault:!1,couponBaseInfoList:t,vipLogo:e}),0!=t.length&&(clearInterval(o.state.timer),o.cutDown())):201==n.code||202==n.code?o.setState({showDefault:!1,loginStatus:!1,couponBaseInfoList:[]}):((0,_indexWeapp4.showToast)({title:n.msg}),o.setState({couponBaseInfoList:[]}))}).catch(function(e){(0,_indexWeapp4.hideLoading)(),o.setState({showDefault:!0,defaultType:2,defaultTips:"抱歉活动不存在"})})}catch(e){alert("fetchData-e",e),this.setState({showDefault:!0,defaultType:2,defaultTips:"抱歉活动不存在---"+e})}}},{key:"collectNum",value:function(e){var t=e.lat,t=void 0===t?"":t,e=e.lng,e=void 0===e?"":e,n=this.$router.params,o=n.channel,a=void 0===o?"":o,o=n.edisonid,i=void 0===o?"":o,o=n.fromid,s=void 0===o?"":o,o=n.pin,n=void 0===o?"":o,o=(0,_indexWeapp9.getStorageSync)("login_info")||{},r={activityId:i,channelCode:a,businessType:1,stressTest:!1,fromId:s,longitude:e,latitude:t};r.pin=n||o.PDJ_H5_PIN||"",(0,_differentIndustry.collectCPSNum)(r).then(function(e){(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:"getedison",click_par:{channel:a,fromid:s,pin:r.pin,edisonid:i}})}).catch(function(e){})}},{key:"fetchStroeData",value:function(){var t=this,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=((0,_indexWeapp4.showLoading)(),this.$router.params.channel),o={channel:e,type:1};n&&(o=_extends({channel:e},n)),(0,_differentIndustry.enterWeighSort)(o).then(function(e){(0,_indexWeapp4.hideLoading)(),0==e.code&&e.result.isJump&&!app.globalData._hasJump&&(app.globalData._hasJump=!0,t.goToStore(_extends({},e.result,n)))}).catch(function(e){(0,_indexWeapp4.hideLoading)()})}},{key:"goToStore",value:function(e){var t=e.storeId,n=e.orgCode,o=e.isH5,a=e.lat,e=e.lng,i=this.$router.params,s=i.channel,r=i.popup,p=i.second,u=i.strategyCode,c=i.business,l=i.popupCoupon,i=i.channelBusiness;(0,_indexWeapp3.jump)({type:1==o?"h5":"",to:"store",params:{storeId:t,orgCode:n,addCart:!1,needAddCar:!1,needAddCart:0,isAddCart:!1,needAnchorSku:!0,latitude:void 0===a?"":a,longitude:void 0===e?"":e,channel:s,popup:void 0===r?"":r,second:void 0===p?"":p,channel_name:s||"",strategyCode:void 0===u?"":u,business:void 0===c?"":c,popupCoupon:void 0===l?"":l,channelBusiness:void 0===i?"":i}})}},{key:"goHome",value:function(){(0,_indexWeapp3.jump)(isInWeappH5?{to:"home",type:"h5",params:{}}:{to:"home",params:{}})}},{key:"toUse",value:function(e){var t=this.$router.params,n=t.channel,o=t.popup,t=t.second;(0,_goToByCouponWeapp.goToByCouponId)({couponId:e.couponId,second:void 0===t?"":t,popup:void 0===o?"":o,channel:n,channel_name:n})}},{key:"clickRp",value:function(e,t){(0,_indexWeapp5.clickReport)({create_time:new Date,click_id:e,click_par:t})}},{key:"pvReportFn",value:function(){var e=this.$router.params.channel;(0,_indexWeapp5.pvReport)({create_time:new Date,page_par:{channel:e}})}},{key:"judageIsLogin",value:function(){var n=this;return new Promise(function(e,t){(0,_indexWeapp.isLogin)().then(function(){n.setState({loginStatus:!0}),e(!0)}).catch(function(){isInWeappH5||_indexWeapp2.isJDReactNativeWebView||_indexWeapp2.isJDApp||_indexWeapp2.isJDFinanceApp||_indexWeapp2.isJxApp||_indexWeapp2.isJiSuApp?(0,_indexWeapp.isLoginInWeappH5)().then(function(){n.setState({loginStatus:!0}),e(!0)}).catch(function(){n.setState({loginStatus:!1}),ERROR.type="login",ERROR.message="未登录",e(!1)}):(n.setState({loginStatus:!1}),ERROR.type="login",ERROR.message="未登录",e(!1))})})}},{key:"getLoginToken",value:function(){return(0,_indexWeapp8.request)({functionId:"userLogin/token"})}},{key:"toThrouthMiniLogin",value:function(){var e=this.$router.params,t=e.loginToken,t=void 0===t?"":t,e=e.business;return(0,_indexWeapp8.request)({functionId:"xapp/throughLogin",method:"POST",token:t,body:JSON.stringify({fromSource:5,businessChannel:e,subChannel:"",regChannel:""}),isNeedDealError:!0})}},{key:"_goToLogin",value:function(){for(var e in urlParams="",this.$router.params)urlParams=urlParams+"&"+e+"="+this.$router.params[e];urlParams=urlParams.substr(1);var t=this.$router.params.channel,n=this.state.sendNewUserCoupon;(0,_indexWeapp.goToLogin)({channel:1==n?"vipcooperation_"+t:"",localTargetUrl:"/pages/differentIndustry-t/home/cooperateDetail/index?"+urlParams+"&hasJumpMini="+hasJumpMini})}},{key:"onShareAppMessage",value:function(){return{title:"京东到家",path:"/pages/home/home",imageUrl:"https://storage.360buyimg.com/wximg/common/logo.jpg"}}},{key:"onShareTimeline",value:function(){return{title:"京东到家",path:"/pages/home/home",imageUrl:"https://storage.360buyimg.com/wximg/common/logo.jpg"}}},{key:"getCurrentScrollPos",value:function(){return currentScrollPos}},{key:"onPageScroll",value:function(e){currentScrollPos=e.scrollTop;e=e.scrollTop>=secTopPos;0!=secTopPos&&this.state.secIsTop!=e&&0!=secTopPos&&this.setState({secIsTop:e})}},{key:"setSecTopPos",value:function(e){secTopPos=e+currentScrollPos}},{key:"secKillInfoCallback",value:function(e){this.setState({secKillProIsNull:e})}},{key:"handleSecTabChangeScroll",value:function(){this.childSecGoodsKill&&this.childSecGoodsKill.handleSecTabChangeScroll()}},{key:"handleShowSecTaskSidebar",value:function(e){this.setState({isShowSecTaskSidebar:e})}},{key:"handleSecKillLoading",value:function(e){this.setState({loadingForSecKill:e})}},{key:"setSecList3Pos",value:function(e){secList3Pos=0==e?e:e+currentScrollPos-screenHeight}},{key:"cancelFn",value:function(){var e=this.$router.params.channel;this.clickRp("unclickgotomp",{channel:e}),clearInterval(timer),timer="",this.setState({showWarning:!1,lastTime:3})}},{key:"confirmFn",value:function(){var e=this.$router.params.channel;this.clickRp("clickgotomp",{channel:e}),clearInterval(timer),this.setState({showWarning:!1}),timer="",this.toJumpMini()}},{key:"startShowAlert",value:function(){var e=this,t=this.$router.params.channel,n=(this.clickRp("showgotomp",{channel:t}),this.setState({showWarning:!0}),3);clearInterval(timer),timer=setInterval(function(){timer&&(0<n?(n--,e.setState({lastTime:n})):(e.setState({showWarning:!1}),clearInterval(timer),e.toJumpMini()))},1e3)}},{key:"componentWillUnmount",value:function(){clearInterval(timer)}},{key:"anonymousFunc0",value:function(e){}}]),i}(),_class.$$events=["_goToLogin","toUse","goHome"],_class.multipleSlots=!0,_class.$$componentPath="pages/differentIndustry-t/home/cooperateDetail/index",_temp2);exports.default=Index,Component(require("../../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Index,!0));