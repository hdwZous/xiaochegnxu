"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.request=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_indexWeapp=require("../storage/index.weapp.js"),_indexWeapp2=require("../../constants/index.weapp.js"),_indexWeapp3=require("../utils/index.weapp.js"),_indexWeapp4=require("../getApp/index.weapp.js"),_indexWeapp5=_interopRequireDefault(_indexWeapp4),_aesUtils=require("../utils/aes.utils.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var decryptFail=!1,request=exports.request=function(){var e,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=(0,_indexWeapp5.default)(),d="https://"+t._independent_.config.HOST+"/client?functionId="+n.functionId,i=(0,_indexWeapp.getStorageSync)(_indexWeapp2.ADDRESS_INFO)||{},a=(0,_indexWeapp.getStorageSync)(_indexWeapp2.REAL_ADDRESS_INFO)||{},o=(0,_indexWeapp.getStorageSync)(_indexWeapp2.LOGIN_INFO)||{},p={lat:i.latitude||"",lng:i.longitude||"",lat_pos:a.latitude||"",lng_pos:a.longitude||"",city_id:i.cityId||i.areaCode||i.cityCode||"",deviceToken:(0,_indexWeapp3.getDeviceId)(),deviceId:(0,_indexWeapp3.getDeviceId)(),channel:"wx_xcx",mpChannel:t._independent_.mpChannel||"wx_xcx",platform:"8.26.0",platCode:"mini",appVersion:"8.26.0",appName:"paidaojia",deviceModel:"appmodel",xcxVersion:"8.26.0",business:t._independent_.qrcode.business||t.globalData&&t.globalData.qrcode.business||""};for(e in n.body&&"object"===_typeof(n.body)&&(n.body=JSON.stringify(n.body)),n)p[e]=n[e];var r=o.o2o_m_h5_sid||"",t=(0,_indexWeapp3.getDeviceId)(),s="cart_uuid="+t+"; o2o_m_h5_sid="+r+"; deviceid_pdj_jd="+t;return p.signNeedBody=1,p.signKeyV1=(0,_indexWeapp3.genSignKeyV1)(p),decryptFail?(console.error("降级传输1"),new Promise(function(t,i){wx.request({method:n.method||"GET",url:d,data:p,credentials:"include",header:{sid:o[_indexWeapp2.PDJ_H5_SID_KEY]||"",Cookie:s,"content-type":"application/x-www-form-urlencoded;"},success:function(e){e=e.data||{};e.abTest&&(0,_indexWeapp3.updateAb)(e.abTest),e.result&&e.result.abTest&&(0,_indexWeapp3.updateAb)(e.result.abTest),(n.isNeedDealError||0==e.code?t:i)(e)},fail:function(e){i(e)}})})):new Promise(function(t,i){wx.request({method:n.method||"GET",url:d,data:{djencrypt:(0,_aesUtils.encrypt)(JSON.stringify(p))},credentials:"include",header:{sid:r||"",Cookie:s,"content-type":"application/x-www-form-urlencoded;"},success:function(e){e=e.data||{};"110"==e.code&&1==e.type?(decryptFail=!0,console.error("降级传输2"),wx.request({method:n.method||"GET",url:d,data:p,credentials:"include",header:{sid:o[_indexWeapp2.PDJ_H5_SID_KEY]||"",Cookie:s,"content-type":"application/x-www-form-urlencoded;"},success:function(e){e=e.data||{};e.abTest&&(0,_indexWeapp3.updateAb)(e.abTest),e.result&&e.result.abTest&&(0,_indexWeapp3.updateAb)(e.result.abTest),(n.isNeedDealError||0==e.code?t:i)(e)},fail:function(e){i(e)}})):(e.abTest&&(0,_indexWeapp3.updateAb)(e.abTest),e.result&&e.result.abTest&&(0,_indexWeapp3.updateAb)(e.result.abTest),(n.isNeedDealError||0==e.code?t:i)(e))},fail:function(e){i(e)}})})};