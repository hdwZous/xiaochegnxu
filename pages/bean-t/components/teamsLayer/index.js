"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},_createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),_get=function e(t,n,a){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(a):void 0:null!==(i=Object.getPrototypeOf(t))?e(i,n,a):void 0},_index=require("../../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_indexWeapp2=require("../../../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_bean=require("../../../../common-mp/api/bean.js"),_indexWeapp3=require("../../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_indexWeapp4=require("../../../../npm/@jd/djmp/common-t/js/share/index.weapp.js"),_indexWeapp5=require("../../../../npm/@jd/djmp/common-t/constants/index.weapp.js"),_indexWeapp6=require("../../../../npm/@jd/djmp/common-t/js/storage/index.weapp.js"),_utilsWeapp=require("../../common/utils.weapp.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap),_indexWeapp7=require("../../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var CARVE_BEAN_TYPE=2,REPORT={keyName:{showPopUp:"showDivideWaterPopup",clickPopUp:"clickDivideWaterPopup"},showPopUp:function(e,t){e=this.formatReportData(e,t);(0,_indexWeapp7.clickReport)({click_id:this.keyName.showPopUp,click_par:e})},clickPopUp:function(e,t){e=this.formatReportData(e,t);(0,_indexWeapp7.clickReport)({click_id:this.keyName.clickPopUp,click_par:e})},formatReportData:function(e,t){return{owner:1==e.self||!0,status:{1:"inProgress",2:"success",3:"fail"}[e.groupStatus],mainTitle:e.title,subTitle:e.subtitle,buttonName:e.buttonText,reward:e.carveUpCount,shareStatus:t}}},_throttleFlag=!0,TeamsLayer=(_temp2=_class=function(){function o(){var e,t;_classCallCheck(this,o);for(var n=arguments.length,a=Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t=_possibleConstructorReturn(this,(t=o.__proto__||Object.getPrototypeOf(o)).call.apply(t,[this].concat(a)))).$usedState=["anonymousState__temp3","loopArray155","loopArray156","style","teamInfoShow","subTitle","groupStatus","carveUpCount","self","joinUsers","teamIconUrl","carveUpInfo","buttonId","cloudShow","animateMaps","animateLightning","animateRains","cloudRainPos","animatePlane","planeShow","title","HH","MM","SS","MS","buttonText","shareInfo","countDown","timer","setShowTeamInfoByChild","setShowRisePopByChild","updataRainsView","updataCurrentData"],t.config={navigationBarTitleText:""},t.customComponents=[],_possibleConstructorReturn(t,e)}return _inherits(o,_index.Component),_createClass(o,[{key:"_constructor",value:function(e){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"_constructor",this).call(this,e),this.state={teamIconUrl:"https://storage.360buyimg.com/wxapp/myinfo/icon_myinfo_header_for_login.png",cloudShow:!1,animateLightning:"",animateRains:"",animatePlane:"",planeShow:!1,cloudRainPos:[],animateMaps:{animateCloudLeft:"",animateCloudMid:"",animateCloudRight:""},shareInfo:{},carveUpInfo:{},countDown:{day:0,HH:"00",MM:"00",SS:"00",MS:"0"},timer:null},this.$$refs=[]}},{key:"_createData",value:function(){var e=this,t=(this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{},this.$prefix,this.__state),n=(t.cloudShow,t.animateLightning,t.animateRains,t.animatePlane,t.planeShow,t.cloudRainPos),a=(t.animateMaps,t.carveUpInfo),i=t.countDown,t=(t.teamIconUrl,this.__props.teamInfoShow),o=a.title,o=void 0===o?"":o,r=a.subTitle,r=void 0===r?"":r,s=a.buttonText,s=void 0===s?"":s,p=a.carveUpCount,p=void 0===p?0:p,c=a.joinUsers,c=void 0===c?[]:c,d=a.buttonId,l=a.groupStatus,u=a.self,h=(i.day,i.HH),h=void 0===h?"00":h,m=i.MM,m=void 0===m?"00":m,f=i.SS,f=void 0===f?"00":f,i=i.MS,i=void 0===i?"0":i,g=(this.anonymousFunc0=function(){return e.hideTeamInfo()},1==d?_extends({},a,{path:"/pages/bean-t/index?activityId="+(a.activityId||"")+"&groupId="+(a.groupId||"")+"&beansource=rainTeam"}):null),_=c&&0<c.length?c.map(function(e,t){return e={$original:(0,_index.internal_get_original)(e)},{$loopState__temp2:_extends({},a,{path:"/pages/bean-t/index?activityId="+(a.activityId||"")+"&groupId="+(a.groupId||"")+"&beansource=rainTeam"}),$original:e.$original}}):[],n=n.map(function(e,t){var n={left:(e={$original:(0,_index.internal_get_original)(e)}).$original.left+"px",top:e.$original.top+"px"};return{styleDes:n,$loopState__temp5:(0,_index.internal_inline_style)(n),$original:e.$original}});return Object.assign(this.__state,{anonymousState__temp3:g,loopArray155:_,loopArray156:n,style:_indexModuleScssMap2.default,teamInfoShow:t,subTitle:r,groupStatus:l,carveUpCount:p,self:u,joinUsers:c,buttonId:d,title:o,HH:h,MM:m,SS:f,MS:i,buttonText:s}),this.__state}},{key:"componentDidMount",value:function(){this.setRainPosition()}},{key:"componentWillUnMount",value:function(){clearInterval(this.state.timer)}},{key:"_throttle",value:function(e,t){_throttleFlag&&(_throttleFlag=!1,e.apply(this,arguments),setTimeout(function(){_throttleFlag=!0},t||2e3))}},{key:"stopHide",value:function(e){e.stopPropagation()}},{key:"hideTeamInfo",value:function(){this.props.setShowTeamInfoByChild(!1),clearInterval(this.state.timer)}},{key:"showRainAnimation",value:function(){this.state.cloudShow;this.setState({planeShow:!0}),this.startRain()}},{key:"startRain",value:function(){var e=this;this.setState({animatePlane:"animatePlane"});setTimeout(function(){e.setState({animateLightning:"lightning_animation",animateRains:"animateRains",animateMaps:{animateCloudLeft:"animateCloudLeft",animateCloudMid:"animateCloudMid",animateCloudRight:"animateCloudRight"},cloudShow:!0,planeShow:!1}),setTimeout(function(){e.setState({animateLightning:"",animateRains:"",animatePlane:"",animateMaps:{animateCloudLeft:"",animateCloudMid:"",animateCloudRight:""},cloudShow:!1})},2e3)},1800)}},{key:"getRainByApi",value:function(){var t=this,e=this.state.carveUpInfo.businessId;(0,_bean.artificialRain)({artificialRainId:void 0===e?"":e}).then(function(e){0==e.code?(t.showRainAnimation(),setTimeout(function(){t.props.setShowRisePopByChild(e.result)},2500)):(0,_indexWeapp.showToast)({title:e.msg,icon:"none",duration:2e3})}).catch(function(e){(0,_indexWeapp.showToast)({title:e.msg,icon:"none",duration:2e3})})}},{key:"setRainPosition",value:function(){var n=[];[].concat(_toConsumableArray(Array(20))).forEach(function(){var e=Math.ceil(180*Math.random()+10),t=100*Math.random()+10;n.push({left:e,top:t})}),this.setState({cloudRainPos:n})}},{key:"getCarveUpInfo",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=this,i=arguments[1],o=arguments[2],e=e.groupId,e=void 0===e?"":e;this.state.timer&&clearInterval(this.state.timer),(0,_bean.getCarveUp)({groupId:e,type:2}).then(function(e){var t,n;0==e.code?(0==(n=(t=void 0===(t=e.result)?{}:t).groupStatus)?a.openCarveUpInfo():(2==n&&(a.props.updataRainsView(t),a.props.updataCurrentData()),a.carveUpInfoView(t)),i&&i(),n=1==t.buttonId,REPORT.showPopUp(t,n)):setTimeout(function(){(0,_indexWeapp.showToast)({title:e.msg,icon:"none",duration:2e3})},o||0)}).catch(function(e){setTimeout(function(){(0,_indexWeapp.showToast)({title:e.msg,icon:"none",duration:2e3})},o||0)})}},{key:"openCarveUpInfo",value:function(){var t=this,e=(0,_indexWeapp6.getStorageSync)(_indexWeapp5.LOGIN_INFO)||{},n=e.nickname,n=void 0===n?"":n,a=e.avatar,a=void 0===a?"":a,i=e.unionid_pdj_jd_new,i=void 0===i?"":i,e=e.openId,e=void 0===e?"":e,o=(new Date).getTime();(0,_bean.openCarveUp)({nickName:n,nickHeadUrl:a,wcUnionId:i,openId:e,formId:"",type:CARVE_BEAN_TYPE,traceId:o}).then(function(e){0==e.code?t.getCarveUpInfo():(t.props.setShowTeamInfoByChild(!1),(0,_indexWeapp.showToast)({title:e.msg,icon:"none",duration:2e3}))}).catch(function(e){t.props.setShowTeamInfoByChild(!1),(0,_indexWeapp.showToast)({title:e.msg,icon:"none",duration:2e3})})}},{key:"carveUpInfoView",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=(this.setState({carveUpInfo:e}),e.remainTime);e.groupStatus;t&&this.showCountDown(t)}},{key:"showCountDown",value:function(e){var n=this;this.countDown(e,function(e){var t;e.end&&(clearInterval(n.state.timer),n.getBeansShareInfo&&n.getBeansShareInfo({})),0<e.day?(t={day:e.day,HH:e.hour,MM:e.minute,SS:e.second,MS:e.millisecond},n.setState({countDown:t})):(t={HH:e.hour,MM:e.minute,SS:e.second,MS:e.millisecond},n.setState({countDown:t}))})}},{key:"countDown",value:function(i,o){this.state.timer&&(clearInterval(this.state.timer),this.setState({timer:null}));var r=setInterval(function(){var e=0,t=0,n=0,a=0;0<i&&(e=Math.floor(i/1e3/60/60),t=Math.floor(i/1e3/60%60),n=Math.floor(i/1e3%60),a=Math.floor(i%1e3/100)),e<=9&&(e="0"+e),t<=9&&(t="0"+t),n<=9&&(n="0"+n),o(0<i?{day:0,hour:e,minute:t,second:n,timer:r,end:!1,millisecond:a}:{hour:"00",minute:"00",second:"00",millisecond:"00",timer:r,end:!0}),i-=100},100);this.setState({timer:r})}},{key:"openBeansShareFun",value:function(){return new Promise(function(t,n){var e=(0,_indexWeapp6.getStorageSync)(_indexWeapp5.LOGIN_INFO)||{},a=e.nickname,a=void 0===a?"":a,i=e.avatar,i=void 0===i?"":i,o=e.unionid_pdj_jd_new,o=void 0===o?"":o,e=e.openId,e=void 0===e?"":e,r=(new Date).getTime();(0,_bean.openCarveUp)({nickName:a,nickHeadUrl:i,wcUnionId:o,openId:e,formId:"",type:CARVE_BEAN_TYPE,traceId:r}).then(function(e){0==e.code?t(!0):n(!1)}).catch(function(){n(!1)})})}},{key:"attendBeansShare",value:function(e){var t=this,n=e.groupId,n=void 0===n?"":n,e=e.activityId,e=void 0===e?"":e,a=(0,_indexWeapp6.getStorageSync)(_indexWeapp5.LOGIN_INFO)||{},i=n+","+e+","+(a.openId||"");(0,_bean.joinCarveUp)({encryptData:(0,_utilsWeapp.encrypt)(i),groupId:n,activityId:e,nickName:a.nickname,nickHeadUrl:a.avatar,wcUnionId:a.unionid_pdj_jd_new||"",formId:"",openId:a.openId||"",type:CARVE_BEAN_TYPE,traceId:new Date}).then(function(e){0==e.code?t.getCarveUpInfo(e.result):(0,_indexWeapp.showToast)({title:e.msg,icon:"none",duration:2e3})}).catch(function(e){(0,_indexWeapp.showToast)({title:e.msg,icon:"none",duration:2e3})})}},{key:"btnEvent",value:function(e){var t=this;this._throttle(function(){t.handleClickTeamInfoBtn(e)},1e3),REPORT.clickPopUp(e,!1)}},{key:"handleClickTeamInfoBtn",value:function(t){var n=this,a=t.buttonId;(0,_indexWeapp3.isLogin)().then(function(e){1!=a&&(2==a||6==a?n.openBeansShareFun().catch(function(e){n.getCarveUpInfo({groupId:""})}):5==a?n.getCarveUpInfo({groupId:""}):3==a?n.attendBeansShare(t):4==a?(n.hideTeamInfo(),n.getRainByApi()):7!=a&&8!=a||n.hideTeamInfo())}).catch(function(e){(0,_indexWeapp3.goToLogin)()})}},{key:"onInviteFriend",value:function(){var e=this.state.carveUpInfo;(0,_indexWeapp3.isLogin)().then(function(){}).catch(function(e){(0,_indexWeapp3.goToLogin)()}),REPORT.clickPopUp(e,!0)}},{key:"isCompatible",value:function(e,t){try{e=e.split("."),t=t.split(".");for(var n=Math.max(e.length,t.length);e.length<n;)e.push("0");for(;t.length<n;)t.push("0");for(var a=0;a<n;a++){var i=parseInt(e[a]),o=parseInt(t[a]);if(o<i)return 1;if(i<o)return-1}return 0}catch(e){}}},{key:"onlyCallUpWechat",value:function(e){var t=e.shareUrl,t=void 0===t?"https://storage.360buyimg.com/wximg/bean/share.jpg":t,n=e.shareText,n=void 0===n?"京东到家":n,a=e.activityId,e=e.groupId,a="pages/bean-t/index?activityId="+(void 0===a?"":a)+"&groupId="+(void 0===e?"":e)+"&beansource=rainTeam",e="https://testpdjm.jd.com/taroh5/h5dist/#/pages/bean-t/index",i="京东到家鲜豆庄园",o="gh_5103b94a8a56";(0,_indexWeapp.hideLoading)(),_indexWeapp2.isIOS?_indexWeapp2.supportDJSHWK?window.webkit.messageHandlers.MobileNavi.postMessage({method:"toShareNew",params:JSON.stringify({method:"3",chat:{shareType:"2",data:{title:n,appId:o,imageUrl:t,miniProgram:a,shareUrl:e},degradeParams:{title:n,dec:i,icon:t,degradeUrl:t}},square:{},imgUrl:{},userAction:{}}),callBackName:null,callBackId:null}):toShareNew(JSON.stringify({method:"3",chat:{shareType:"2",data:{title:n,appId:o,imageUrl:t,miniProgram:a,shareUrl:e},degradeParams:{title:n,dec:i,icon:t,degradeUrl:t}},square:{},imgUrl:{},userAction:{}})):(_indexWeapp2.isAndroid,window.djJava.toShareNew("3",JSON.stringify({shareType:"2",data:{title:n,appId:o,imageUrl:t,miniProgram:a,shareUrl:e},degradeParams:{title:n,dec:i,icon:t,degradeUrl:t}}),"","",""))}},{key:"getCircleSharePic",value:function(){(0,_indexWeapp.showLoading)()}},{key:"openShare",value:function(){var t=this;this._throttle(function(){(0,_indexWeapp.showLoading)(),_indexWeapp2.isDaojiaApp&&0<=t.isCompatible(String(_indexWeapp2.djAppVersion),String(7))?((0,_indexWeapp.hideLoading)(),t.onlyCallUpWechat(t.state.carveUpInfo)):t.getCircleSharePic().then(function(e){(0,_indexWeapp.hideLoading)(),e.result?t.handleOpenShare(e.result):t.handleOpenShare()}).catch(function(){(0,_indexWeapp.hideLoading)(),t.handleOpenShare()})})}},{key:"handleOpenShare",value:function(e){var t=this.state.carveUpInfo,e=e||"https://img10.360buyimg.com/mobilecms/jfs/t1/48798/36/8506/78945/5d5f5808E4c17f412/219404b469b14dd3.jpg",n=""+window.location.origin+window.location.pathname+"#/pages/sharePreview-t/index?image="+e+"&title=鲜豆庄园&beansource=rainTeam",n={title:t.title||"鲜豆庄园",desc:"京东到家鲜豆庄园",shareUrl:n,imgUrl:"https://img30.360buyimg.com/mobilecms/jfs/t1/65465/34/7772/289742/5d5ba9a2Ededf3e31/d9c6737e7ed4df17.png",appId:"gh_5103b94a8a56",mpImgUrl:t.shareUrl||"https://img30.360buyimg.com/mobilecms/jfs/t1/65465/34/7772/289742/5d5ba9a2Ededf3e31/d9c6737e7ed4df17.png",path:"pages/bean-t/index?activityId="+(t.activityId||"")+"&groupId="+(t.groupId||"")+"&beansource=rainTeam",pyqImg:e||"",callback:"",clickcallback:"",timeline_title:"",channel:"Wxfriends",qrparam:{top_pic:t.title||"鲜豆庄园",mid_pic:"",slogan:"京东二维码分享",qr_title:t.title||"鲜豆庄园",qr_content:"京东到家鲜豆庄园",qr_direct:e}};n.pyqImg&&(0,_indexWeapp4.openShare)(n)}},{key:"anonymousFunc0",value:function(e){}}]),o}(),_class.$$events=["anonymousFunc0","stopHide","onInviteFriend","btnEvent"],_class.$$componentPath="pages/bean-t/components/teamsLayer/index",_temp2);exports.default=TeamsLayer,Component(require("../../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(TeamsLayer));