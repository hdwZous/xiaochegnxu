"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var o,t=arguments[n];for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},_index=require("../../../@legos/js-security-jdxcx/dist/index.js"),_index2=_interopRequireDefault(_index),_util=require("./util.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var c=e.apply(this,arguments);return new Promise(function(a,r){return function n(e,o){try{var t=c[e](o),i=t.value}catch(e){return void r(e)}if(!t.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});a(i)}("next")})}}var plugin=requirePlugin("loginPlugin"),pt_key=plugin.getPtKey()||"",sign={instance:null,init:function(){sign.instance=null},genSign:function(){return null===sign.instance&&(sign.instance=new _index2.default({appId:"dj_mini",debug:!0,preRequest:!1,onSign:function(e){e=e.code;console.log("onSign",void 0===e?"":e)},onRequestTokenRemotely:function(e){var n=e.code,e=e.message;console.log("onRequestTokenRemotely:",void 0===n?"":n,void 0===e?"":e)},onRequestToken:function(e){var n=e.code,e=e.message;console.log("onRequestToken",void 0===n?"":n,void 0===e?"":e)}})),sign.instance}},api=function(f){return new Promise((o=_asyncToGenerator(regeneratorRuntime.mark(function e(o,n){var t,i,a,r,c,s,l,d,u,g,p;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=getApp(),i=t.globalData,a=s=g="",((u=wx.getStorageSync("address_info"))&&u.cityId||(u=t.globalData.addressInfo||{}).cityId)&&(g=u.cityId||"",s=u.latitude||"",a=u.longitude||""),u=wx.getStorageSync("login_info")||{},l=u.o2o_m_h5_sid||"",u=u.PDJ_H5_PIN||"",d=getUUIDMD5(),c={latitude:"",longitude:""};try{c=wx.getStorageSync("realTimeLocation")}catch(e){}if(p=i.qrcode&&i.qrcode.business+""||"",r=i.channelCode||"",c={channel:i.config.channel,platform:6,platCode:i.config.platCode,mpChannel:"wx_xcx",appVersion:f.appVersion||i.config.platform,xcxVersion:f.xcxVersion||i.config.xcxVersion,appName:i.config.appName,functionId:f.functionId,body:JSON.stringify(f.body)||"",afsImg:f.afsImg||"",lat_pos:c.latitude||"",lng_pos:c.longitude||"",lat:s,lng:a,city_id:g,deviceToken:getUUIDMD5(),deviceId:getUUIDMD5(),deviceModel:"appmodel",business:p,traceId:getrandom()+Date.now(),channelCode:r,pageId:f.pageId||"",appid:"dj_mini",t:(new Date).getTime(),loginType:12},"string"!=typeof(s=_extends({},c,f)).body&&(s.body=JSON.stringify(s.body)),a=(0,_util.ColorParams)(s),g="cart_uuid="+getUUIDMD5()+"; pt_key="+(pt_key||f.pt_key)+"; o2o_m_h5_sid="+l+"; deviceid_pdj_jd="+d+"; PDJ_H5_PIN="+u,p={Cookie:g,sid:t.globalData.loginStateInfo&&t.globalData.loginStateInfo.o2o_m_h5_sid||"",type:"application/x-www-form-urlencoded"},r=(0,_util.ColorHeader)(p),c={1:"api.m.jd.com",3:"beta-api.m.jd.com",2:"beta-api2.m.jd.com",4:"beta-api3.m.jd.com"},s=wx.getStorageSync("envVersionIndex")||"1",l="https://"+c[s]+"/client.action?appid="+a.appid+"&functionId="+f.functionId,d=f.method||"GET",delete a.method,delete a.pt_key,console.log("========"),console.log("header",r),console.log("params",a),console.log("url",l),console.log("method",d),f.sign)return e.prev=34,u={functionId:a.functionId,appid:a.appid,appVersion:a.clientVersion,client:a.client,t:a.t,body:a.body},g=sign.genSign()||{},e.next=39,g.sign(u);e.next=49;break;case 39:p=e.sent,a.h5st=encodeURI(p.h5st),wx.request({url:l,data:a,method:d,header:r,success:function(e){if(200==e.statusCode){var n=e.data;if(!n||"0"!=n.code)if(n.echo)n.msg=n.echo;else if("201"==n.code||"202"==n.code){i.loginStateInfo={};try{wx.setStorageSync("login_info",{})}catch(e){console.log(e)}wx.navigateTo({url:"/pages/newLogin/login/login",complete:function(){t.globalData.reLogin=!1},buried_position:"colorapi"})}}o(e)},fail:function(e){n(e)}}),e.next=47;break;case 44:e.prev=44,e.t0=e.catch(34),console.error(e.t0);case 47:e.next=50;break;case 49:wx.request({url:l,data:a,method:d,header:r,success:function(e){if(e.isColor=1,200==e.statusCode){var n=e.data;if(!n||"0"!=n.code)if(n.echo)n.msg=n.echo;else if("201"==n.code||"202"==n.code){i.loginStateInfo={};try{wx.setStorageSync("login_info",{})}catch(e){console.log(e)}wx.navigateTo({url:"/pages/newLogin/login/login",complete:function(){t.globalData.reLogin=!1},buried_position:"colorapi"})}}o(e)},fail:function(e){n(e)}});case 50:case"end":return e.stop()}},e,void 0,[[34,44]])})),function(e,n){return o.apply(this,arguments)}));var o};function getUUIDMD5(){var e=getApp(),n=e.globalData.uuId;if(!(n=n||wx.getStorageSync("uuId"))){for(var o=[],t="0123456789abcdef",i=0;i<36;i++)o[i]=t.substr(Math.floor(16*Math.random()),1);o[14]="4",o[19]=o[19]&&t.substr(11,1),o[8]=o[13]=o[18]=o[23]="-",n=o.join(""),e.globalData.uuId=n,wx.setStorageSync("uuId",n)}return n}function getrandom(){for(var e=[],n="0123456789abcdefghkhijklmn",o=0;o<36;o++)e[o]=n.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=e[19]&&n.substr(11,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}exports.default=api;