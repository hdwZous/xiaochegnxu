"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var o,t=arguments[n];for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},_index=require("../../../@legos/js-security-jdxcx/dist/index.js"),_index2=_interopRequireDefault(_index),_util=require("./util.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var c=e.apply(this,arguments);return new Promise(function(a,r){return function n(e,o){try{var t=c[e](o),i=t.value}catch(e){return void r(e)}if(!t.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});a(i)}("next")})}}var plugin=requirePlugin("loginPlugin"),pt_key=plugin.getPtKey()||"",sign={instance:null,init:function(){sign.instance=null},genSign:function(){return null===sign.instance&&(sign.instance=new _index2.default({appId:"dj_mini",debug:!0,preRequest:!1,onSign:function(e){e=e.code;console.log("onSign",void 0===e?"":e)},onRequestTokenRemotely:function(e){var n=e.code,e=e.message;console.log("onRequestTokenRemotely:",void 0===n?"":n,void 0===e?"":e)},onRequestToken:function(e){var n=e.code,e=e.message;console.log("onRequestToken",void 0===n?"":n,void 0===e?"":e)}})),sign.instance}},api=function(_){return new Promise((o=_asyncToGenerator(regeneratorRuntime.mark(function e(o,t){var i,a,r,n,c,s,l,d,u,g,p,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=getApp(),a=i.globalData,f=d=n="",((p=wx.getStorageSync("address_info"))&&p.cityId||(p=i.globalData.addressInfo||{}).cityId)&&(n=p.cityId||"",d=p.latitude||"",f=p.longitude||""),p=wx.getStorageSync("login_info")||{},u=p.o2o_m_h5_sid||"",p=p.PDJ_H5_PIN||"",g=getUUIDMD5(),l={latitude:"",longitude:""};try{l=wx.getStorageSync("realTimeLocation")}catch(e){}if(c=a.qrcode&&a.qrcode.business+""||"",s=a.channelCode||"",l={channel:a.config.channel,platform:6,platCode:a.config.platCode,mpChannel:"wx_xcx",appVersion:_.appVersion||a.config.platform,xcxVersion:_.xcxVersion||a.config.xcxVersion,appName:a.config.appName,functionId:_.functionId,body:JSON.stringify(_.body)||"",afsImg:_.afsImg||"",lat_pos:l.latitude||"",lng_pos:l.longitude||"",lat:d,lng:f,city_id:n,deviceToken:getUUIDMD5(),deviceId:getUUIDMD5(),deviceModel:"appmodel",business:c,traceId:getrandom()+Date.now(),channelCode:s,pageId:_.pageId||"",appid:"dj_mini",t:(new Date).getTime(),loginType:12},"string"!=typeof(d=_extends({},l,_)).body&&(d.body=JSON.stringify(d.body)),r=(0,_util.ColorParams)(d),f="cart_uuid="+getUUIDMD5()+"; pt_key="+(pt_key||_.pt_key)+"; o2o_m_h5_sid="+u+"; deviceid_pdj_jd="+g+"; PDJ_H5_PIN="+p,n={Cookie:f,sid:i.globalData.loginStateInfo&&i.globalData.loginStateInfo.o2o_m_h5_sid||"",type:"application/x-www-form-urlencoded"},c=(0,_util.ColorHeader)(n),s={1:"api.m.jd.com",3:"beta-api.m.jd.com",2:"beta-api2.m.jd.com",4:"beta-api3.m.jd.com"},l=wx.getStorageSync("envVersionIndex")||"1",d="https://"+s[l]+"/client.action?appid="+r.appid+"&functionId="+_.functionId,u=_.method||"GET",delete r.method,delete r.pt_key,console.log("========"),console.log("header",c),console.log("params",r),console.log("url",d),console.log("method",u),_.sign)return e.prev=34,g={functionId:r.functionId,appid:r.appid,appVersion:r.clientVersion,client:r.client,t:r.t,body:r.body},p=sign.genSign()||{},e.next=39,p.sign(g);e.next=49;break;case 39:f=e.sent,r.h5st=encodeURI(f.h5st),wx.request({url:d,data:r,method:u,header:c,success:function(e){if(200==e.statusCode){var n=e.data;if(!n||"0"!=n.code)if(n.echo)n.msg=n.echo;else if("201"==n.code||"202"==n.code){a.loginStateInfo={};try{wx.setStorageSync("login_info",{})}catch(e){console.log(e)}wx.navigateTo({url:"/pages/newLogin/login/login",complete:function(){i.globalData.reLogin=!1},buried_position:"colorapi"})}}o(e)},fail:function(e){t(e)}}),e.next=47;break;case 44:e.prev=44,e.t0=e.catch(34),console.error(e.t0);case 47:e.next=50;break;case 49:wx.request({url:d,data:r,method:u,header:c,success:function(e){if(e.isColor=1,200==e.statusCode){var n=e.data;if(n&&"0"==n.code)o(e);else{if(n.echo)n.msg=n.echo;else if(r.isNeedDealError&&o(e),"201"==n.code||"202"==n.code){a.loginStateInfo={};try{wx.setStorageSync("login_info",{})}catch(e){console.log(e)}wx.navigateTo({url:"/pages/newLogin/login/login",complete:function(){i.globalData.reLogin=!1},buried_position:"colorapi"})}t(e)}}else t(e)},fail:function(e){t(_extends({},e,{isColor:1}))}});case 50:case"end":return e.stop()}},e,void 0,[[34,44]])})),function(e,n){return o.apply(this,arguments)}));var o};function getUUIDMD5(){var e=getApp(),n=e.globalData.uuId;if(!(n=n||wx.getStorageSync("uuId"))){for(var o=[],t="0123456789abcdef",i=0;i<36;i++)o[i]=t.substr(Math.floor(16*Math.random()),1);o[14]="4",o[19]=o[19]&&t.substr(11,1),o[8]=o[13]=o[18]=o[23]="-",n=o.join(""),e.globalData.uuId=n,wx.setStorageSync("uuId",n)}return n}function getrandom(){for(var e=[],n="0123456789abcdefghkhijklmn",o=0;o<36;o++)e[o]=n.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=e[19]&&n.substr(11,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}exports.default=api;