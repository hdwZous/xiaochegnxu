"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,i=arguments[t];for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},_createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),_get=function e(t,n,i){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);return void 0!==o?"value"in o?o.value:void 0!==(o=o.get)?o.call(i):void 0:null!==(o=Object.getPrototypeOf(t))?e(o,n,i):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_indexWeapp2=require("../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_indexWeapp3=require("../../npm/@jd/djmp/common-t/js/jump/index.weapp.js"),_indexWeapp4=require("../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_indexWeapp5=require("../../npm/@jd/djmp/common-t/js/location/index.weapp.js"),_index3=require("./api/index.js"),_indexModuleScssMap=require("./index.module.scss.map.js"),_indexModuleScssMap2=_interopRequireDefault(_indexModuleScssMap);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(a,r){return function t(e,n){try{var i=s[e](n),o=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(o).then(function(e){t("next",e)},function(e){t("throw",e)});a(o)}("next")})}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var isInWeappH5=(0,_indexWeapp2.getH5InWeappFlag)(),isH5=!1,isWeapp=!0,location={},Index=(_temp2=_class=function(){function a(){var e,n;_classCallCheck(this,a);for(var t=arguments.length,i=Array(t),o=0;o<t;o++)i[o]=arguments[o];return(e=n=_possibleConstructorReturn(this,(e=a.__proto__||Object.getPrototypeOf(a)).call.apply(e,[this].concat(i)))).$usedState=["anonymousState__temp6","$compid__193","$compid__194","style","anonymousState__temp","position","anonymousState__temp2","isLogin","anonymousState__temp3","defaultView","isOrderBtn","anonymousState__temp4","anonymousState__temp5","currentPage","showNewUser","shopList","categoryList","isDialog","dialogList","showFlag","statusBarH","toBar"],n.config={navigationBarTitleText:"新人专区",navigationBarBackgroundColor:"#fff",navigationBarTextStyle:"black",navigationStyle:"custom"},n.callNativeClose=function(){(0,_indexWeapp4.clickReport)({click_id:"clickLayer",click_par:{userAction:n.retainUserAction,btnName:"leave",type:"retain"}}),_indexWeapp2.isDaojiaApp&&0<=n.isCompatible(String(_indexWeapp2.djAppVersion),String("8.6.0"))?_indexWeapp2.isIOS?_indexWeapp2.supportDJSHWK&&window.webkit.messageHandlers.MobileNavi.postMessage({method:"closeWebview",callBackName:null,callBackId:null}):_indexWeapp2.isAndroid&&window.djJava.closeWebview&&window.djJava.closeWebview():n.childCustomNavBg.goback()},n.weappIsDialog=function(){var e=n.state.showFlag;e?((0,_indexWeapp4.clickReport)({click_id:"click_open",click_par:{userAction:n.retainUserAction,type:"retain"}}),n.setState({isDialog:e})):n.childCustomNavBg.goback()},n.initiativeCloseLog=function(){(0,_indexWeapp4.clickReport)({click_id:"clickLayer",click_par:{userAction:n.retainUserAction,btnName:"close",type:"retain"}}),n.setState({showFlag:!1,isDialog:!1})},n.onRef=function(e){n.child=e},n.showDefault=function(e){n.setState({defaultView:e})},n.getHotsList=function(e){n.hotsList=e},n.fixShowNewUser=function(e,t){e=_defineProperty({},e,t||[]);n.setState(_extends({},e),function(){})},n.toHotsScroll=function(){var t,e;n.state.isLogin&&(t=void 0,(e=_index2.default.createSelectorQuery()).select("#hotCategory").boundingClientRect(),e.selectViewport().scrollOffset(),e.exec(function(e){t=e[0].top+e[1].scrollTop,_index2.default.pageScrollTo({scrollTop:t,duration:300})}))},n.customComponents=["Custom","OrderBtn","Dialog","Default","Coupons","Hots","Shops"],_possibleConstructorReturn(n,e)}var e,t,n,i;return _inherits(a,_index.Component),_createClass(a,[{key:"_constructor",value:function(e){var t=this;_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"_constructor",this).call(this,e),this.userAction={},this.retainUserAction={},this.goToLoginParams={localTargetUrl:"/pages/newUser-t/index"},this.hotsList=0,this.state={currentPage:1,isLogin:null,position:null,defaultView:!1,showNewUser:2,shopList:[],categoryList:[],isDialog:!1,dialogList:[],showFlag:null,statusBarH:20,toBar:44},this.$$refs=[{type:"component",id:"PoHeq",refName:"",fn:function(e){return t.childCustomNavBg=e}},{type:"component",id:"YcfCd",refName:"hots",fn:null},{type:"component",id:"LaWsy",refName:"shops",fn:null}]}},{key:"componentWillMount",value:(i=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=!1,e.prev=1,e.next=4,this.judageIsLogin();case 4:t=e.sent,e.next=10;break;case 7:e.prev=7,e.t0=e.catch(1),t=!1;case 10:t||(0,_indexWeapp.goToLogin)(this.goToLoginParams),n=this,_index2.default.getSystemInfo({success:function(e){n.setState({statusBarH:e.statusBarHeight}),"ios"!=e.platform&&"android"==e.platform?n.setState({toBar:48}):n.setState({toBar:44})}});case 13:case"end":return e.stop()}},e,this,[[1,7]])})),function(){return i.apply(this,arguments)})},{key:"componentDidShow",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(t=this.$router.params).userAction&&(this.userAction=decodeURIComponent(t.userAction)),n=!1,e.prev=3,e.next=6,this.judageIsLogin();case 6:n=e.sent,e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),n=!1;case 12:return this.setState({isLogin:n,params:t}),e.next=15,this.initPage();case 15:t.business&&(getApp().globalData.qrcode.business=t.business||null,getApp().globalData.qrcode.roomid=t.roomId||null),(0,_indexWeapp4.pvReport)({create_time:new Date,page_par:{roomId:t.roomId||null,business:t.business||null,ref_par:{userAction:this.userAction}}});case 17:case"end":return e.stop()}},e,this,[[3,9]])})),function(){return n.apply(this,arguments)})},{key:"onReachBottom",value:function(){var e=this,t=this.state.currentPage;this.setState({currentPage:t+1},function(){e.child&&e.child.fetchData()})}},{key:"newUserRetain",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,i,o=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.state.position,n=this.$router.params.business,n=void 0===n?null:n,t){e.next=4;break}return e.abrupt("return");case 4:i={city_id:t.cityId,lng_pos:t.longitude,lat_pos:t.latitude},n&&(i.channel=n),(0,_index3.newUserRetain)(i).then(function(e){e.result.showFlag&&o.djAppShowFlag(),o.retainUserAction=e.result.userAction||{},o.setState({showFlag:e.result.showFlag,dialogList:e.result.products})});case 7:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"djAppShowFlag",value:function(){_indexWeapp2.isDaojiaApp&&0<=this.isCompatible(String(_indexWeapp2.djAppVersion),String("8.6.0"))&&(this.callEnableIntercept(),this.closeWebCall())}},{key:"judageIsLogin",value:function(){return new Promise(function(e,t){(0,_indexWeapp.isLogin)().then(function(){e(!0)}).catch(function(){isInWeappH5||_indexWeapp2.isJDReactNativeWebView||_indexWeapp2.isJDApp||_indexWeapp2.isJDFinanceApp||_indexWeapp2.isJxApp||_indexWeapp2.isJiSuApp?(0,_indexWeapp.isLoginInWeappH5)().then(function(){e(!0)}).catch(function(){t(!1)}):t(!1)})})}},{key:"callEnableIntercept",value:function(){_indexWeapp2.isDaojiaApp&&0<=this.isCompatible(String(_indexWeapp2.djAppVersion),String("8.6.0"))&&(_indexWeapp2.isIOS?_indexWeapp2.supportDJSHWK&&window.webkit.messageHandlers.MobileNavi.postMessage({method:"enableIntercept",params:1,callBackName:null,callBackId:null}):_indexWeapp2.isAndroid&&window.djJava.enableIntercept&&window.djJava.enableIntercept(1))}},{key:"closeWebCall",value:function(){var t=this;window.djWebviewBack=function(){var e=t.state.showFlag;return!!e&&((0,_indexWeapp4.clickReport)({click_id:"click_open",click_par:{userAction:t.retainUserAction,type:"retain"}}),t.setState({isDialog:e}),!0)}}},{key:"isCompatible",value:function(e,t){e=e.split("."),t=t.split(".");for(var n=Math.max(e.length,t.length);e.length<n;)e.push("0");for(;t.length<n;)t.push("0");for(var i=0;i<n;i++){var o=parseInt(e[i]),a=parseInt(t[i]);if(a<o)return 1;if(o<a)return-1}return 0}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};var e=this.$prefix,t=(0,_index.genCompid)(e+"$compid__193"),n=(0,_index.genCompid)(e+"$compid__194"),i=this.__state,o=i.isLogin,a=i.position,r=(i.defaultView,i.categoryList),s=i.shopList,p=i.isDialog,c=i.dialogList,c=void 0===c?[]:c,u=i.statusBarH,i=i.toBar,r=r.length||s.length,s=this._createBannerData(e+"bQheuaGhDO")(),l=a?this._createCouponData(e+"lVaMwAehyU")():null,d=!o&&a?this._createisLoginBtnData(e+"KprrJCiYAy")():null,_=a?this._createHotCategoryData(e+"MLWNehZwwi")():null,a=a?this._createShopsData(e+"kQRjXQKTog")():null,e=(0,_index.internal_inline_style)({display:null===o?"none":""});return _index.propsManager.set({statusBarH:u,toBar:i,weappIsDialog:this.weappIsDialog},t),_index.propsManager.set({isDialog:p,dialogList:c,callNativeClose:this.callNativeClose,initiativeCloseLog:this.initiativeCloseLog,isLogin:o,statusBarH:u,toBar:i,onToStore:this.toStore,retainUserAction:this.retainUserAction},n),Object.assign(this.__state,{anonymousState__temp6:e,$compid__193:t,$compid__194:n,style:_indexModuleScssMap2.default,anonymousState__temp:s,anonymousState__temp2:l,anonymousState__temp3:d,isOrderBtn:r,anonymousState__temp4:_,anonymousState__temp5:a}),this.__state}},{key:"_createBannerData",value:function(e){var n=this;return function(){var e=n.state,t=e.statusBarH,e=e.toBar;return{anonymousState__temp7:(0,_index.internal_inline_style)({marginTop:2*(t+e)+"rpx"}),style:_indexModuleScssMap2.default}}}},{key:"_createCouponData",value:function(i){var o=this;return function(){var e=(0,_index.genCompid)(i+"$compid__195"),t=o.state,n=t.position,t=t.isLogin;return _index.propsManager.set({position:n,isLogin:t,toStore:o.toStore,showDefault:o.showDefault,toHotsScroll:o.toHotsScroll},e),{$compid__195:e}}}},{key:"_createHotCategoryData",value:function(o){var a=this;return function(){var e=(0,_index.genCompid)(o+"$compid__196"),t=a.state,n=t.position,i=t.isLogin,t=t.params;return _index.propsManager.set({position:n,isLogin:i,onToStore:a.toStore,showDefault:a.showDefault,getHotsList:a.getHotsList,fixShowNewUser:a.fixShowNewUser,urlParams:t},e),{$compid__196:e}}}},{key:"_createShopsData",value:function(i){var o=this;return function(){var e=(0,_index.genCompid)(i+"$compid__197"),t=o.state,n=t.position,t=t.currentPage;return _index.propsManager.set({position:n,toStore:o.toStore,currentPage:t,onRef:o.onRef,showDefault:o.showDefault,hotsList:o.hotsList,fixShowNewUser:o.fixShowNewUser},e),{$compid__197:e}}}},{key:"loginBtnEvent",value:function(){return(0,_indexWeapp.goToLogin)(this.goToLoginParams)}},{key:"_createisLoginBtnData",value:function(e){return function(){return{style:_indexModuleScssMap2.default}}}},{key:"toStore",value:function(e){e={userAction:e.userAction,storeId:e.storeId||"",skuId:e.skuId||"",orgCode:e.orgCode||"",longitude:location.longitude,latitude:location.latitude,needAnchorSku:!0,addCart:!0,needAddCar:!0,needAddCart:1,isAddCart:!0};(0,_indexWeapp3.jump)({to:"store",params:e})}},{key:"initPage",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getCurLocation().then(function(e){t.setState({position:e},function(){t.newUserRetain()})});case 2:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"getCurLocation",value:function(){return new Promise(function(t,e){(0,_indexWeapp5.getLocation)().then(function(e){t(location=e)}).catch(function(){e()})})}}]),a}(),_class.$$events=["loginBtnEvent"],_class.multipleSlots=!0,_class.$$componentPath="pages/newUser-t/index",_temp2);exports.default=Index,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(Index,!0));