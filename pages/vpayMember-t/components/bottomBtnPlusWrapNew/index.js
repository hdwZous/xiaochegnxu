"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function a(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,n){return t&&a(e.prototype,t),n&&a(e,n),e}}(),_get=function e(t,n,a){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(a):void 0:null!==(i=Object.getPrototypeOf(t))?e(i,n,a):void 0},_indexWeapp=require("../../../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_indexWeapp2=require("../../../../npm/@jd/djmp/common-t/js/storage/index.weapp.js"),_indexWeapp3=require("../../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_indexWeapp4=require("../../../../npm/@jd/djmp/common-t/constants/index.weapp.js"),_indexWeapp5=require("../../../../npm/@jd/djmp/common-t/js/login/index.weapp.js"),_indexWeapp6=require("../../../../npm/@jd/djmp/common-t/js/openPay/index.weapp.js"),_vpayMember=require("../../api/vpayMember.js"),_index=require("../../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp7=require("../../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_btnPlusWrapModuleScssMap=require("./btnPlusWrap.module.scss.map.js"),_btnPlusWrapModuleScssMap2=_interopRequireDefault(_btnPlusWrapModuleScssMap),_index3=require("../../../../common-mp/pay-sdk/index.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var p=e.apply(this,arguments);return new Promise(function(r,o){return function t(e,n){try{var a=p[e](n),i=a.value}catch(e){return void o(e)}if(!a.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var isWeapp=!0,BottomBtnPlusWrapNew=(_temp2=_class=function(){function r(){var e,t;_classCallCheck(this,r);for(var n=arguments.length,a=Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t=_possibleConstructorReturn(this,(e=r.__proto__||Object.getPrototypeOf(r)).call.apply(e,[this].concat(a)))).$usedState=["id","btnNoFixed","style","showBtnAnim","showAgreement","agreementCheck","userCardType","isAB","btnData","anonymousState__temp","checkOrderParams","pending","isNewPayFn","showRenewAlert","vipFlag","fromChannel","cityId","longitude","latitude","storeId","goToPage","isToPageEvent"],t.plusAgreeHandle=function(){(0,_indexWeapp5.isLogin)().then(function(){t.openVip()}).catch(function(){(0,_indexWeapp5.goToLogin)({})})},t.getPaySource=function(){return(_indexWeapp.isWeixin?"isWeixin":_indexWeapp.isDaojiaApp&&"isDaojiaApp")||_indexWeapp.isJDReactNativeWebView&&"isJDReactNativeWebView"||"isMiniProgram"},t.clickIntro=function(e){(0,_indexWeapp7.navigateTo)("/pages/vpayMember-t/instructions/index?"+("renew"==e?"page=agrement&type=renew":"page=agrement"))},t.customComponents=[],_possibleConstructorReturn(t,e)}var e,t;return _inherits(r,_index.Component),_createClass(r,[{key:"_constructor",value:function(e){_get(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"_constructor",this).call(this,e),this.state={agreementCheck:!1,checkOrderParams:{},pending:!1,isNewPayFn:"B",showRenewAlert:!1},this.$$refs=[]}},{key:"componentWillMount",value:function(){this.abStrategy()}},{key:"_createData",value:function(){var e=this,t=(this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{},this.$prefix),n=this.__props,a=n.btnNoFixed,i=n.btnData,i=void 0===i?{}:i,r=n.userCardType,o=n.showBtnAnim,o=void 0!==o&&o,p=n.isAB,n=(n.vipFlag,n.showAgreement),n=void 0===n||n,s=this.__state,s=(s.agreementCheck,s.isNewPayFn),c=i.id,c=void 0===c?"":c,t=this._createNewBtnData(t+"TiduyWXXNi")(i);return this.anonymousFunc0=function(){return e.clickIntro()},this.anonymousFunc1=function(){return e.clickIntro("renew")},this.anonymousFunc2=("A"===s||_indexWeapp.isDaojiaApp&&_indexWeapp.isAndroid&&_indexWeapp.djAppVersion<"8.19.0"?this.openVip:this.openVipNew).bind(this),Object.assign(this.__state,{id:c,btnNoFixed:a,style:_btnPlusWrapModuleScssMap2.default,showBtnAnim:o,showAgreement:n,userCardType:r,isAB:p,btnData:i,anonymousState__temp:t}),this.__state}},{key:"_createNewBtnData",value:function(e){var a=this;return function(e){var t=a.state.isNewPayFn,n=a.props.userCardType;return a.anonymousFunc3=("A"===t||_indexWeapp.isDaojiaApp&&_indexWeapp.isAndroid&&_indexWeapp.djAppVersion<"8.19.0"?a.openVip:a.openVipNew).bind(a),{style:_btnPlusWrapModuleScssMap2.default,data:e,userCardType:n}}}},{key:"agreementCheckBtn",value:function(){var e=this;this.setState({agreementCheck:!this.state.agreementCheck},function(){e.props.fromChannel&&(0,_indexWeapp3.clickReport)({page_name:"packageSelection",create_time:new Date,click_id:"selectModule",click_par:{type:"VplusAgreement",status:e.state.agreementCheck?"1":"0"}})})}},{key:"onGoBack",value:function(){_index2.default.navigateBack({delta:0<arguments.length&&void 0!==arguments[0]?arguments[0]:1})}},{key:"refreshbCallInDjApp",value:function(){var e;_indexWeapp.isDaojiaApp&&_indexWeapp.isAndroid&&((e=this).interval&&clearInterval(e.interval),e.interval=setInterval(function(){e.getPayStatus()},1e3))}},{key:"getParams",value:function(t){var n="";return Object.keys(t).forEach(function(e){n=""===n?e+"="+t[e]:n+"&"+e+"="+t[e]}),n}},{key:"getPayStatus",value:function(){var e=this.state.checkOrderParams;e.orderId&&e.srcSystemId&&e.sign&&(0,_vpayMember.queryPayStatusFun)(e).then(function(e){20===e.result&&((0,_indexWeapp7.showToast)({title:"恭喜！您已开通会员 快去使用会员特权吧!",duration:2e3}),setTimeout(function(){_index2.default.redirectTo({url:"https://daojia.jd.com/html/index/user"})},2500))}).catch(function(e){_index2.default.showToast({title:"支付失败，请稍后再试",icon:"none",duration:2e3})})}},{key:"showRenewTip",value:function(){var n=this.props.btnData;return new Promise(function(t,e){_index2.default.showModal({title:"温馨提示",content:n.buyTip,confirmText:"继续购买",cancelText:"暂不购买"}).then(function(e){t(!!e.confirm)})})}},{key:"openVip",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,a,i,r,o,p,s,c,u,d,l,_,m,y,h=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(p=this.props,t=p.userCardType,t=void 0===t?"":t,n=p.cityId,p.longitude,p.latitude,a=p.btnData,i=p.storeId,i=void 0===i?"":i,r=p.goToPage,r=void 0===r?"":r,o=p.fromChannel,p={"体验卡":" expCard","月卡":"monCard","季卡":"quaCard","年卡":"yearCard","连续包月":"conMonCard"},r){if(a.buyTip)return e.next=6,this.showRenewTip();e.next=9}else e.next=14;break;case 6:if(e.sent){e.next=9;break}return e.abrupt("return");case 9:return(0,_indexWeapp7.navigateTo)(""+r),s={type:"bottom",setType:p[a.cardName]||"未知"},(0,_indexWeapp3.clickReport)({create_time:new Date,click_id:"clickMember",click_par:s}),e.abrupt("return");case 14:if(s=this.state,u=s.agreementCheck,c=s.pending,u){e.next=18;break}return(0,_indexWeapp7.showToast)({title:"请先阅读并勾选服务协议"}),e.abrupt("return");case 18:if(c)return(0,_indexWeapp7.showToast)({title:"操作太快了，休息一下吧"}),e.abrupt("return");e.next=21;break;case 21:if(a.buyTip)return e.next=24,this.showRenewTip();e.next=27;break;case 24:if(e.sent){e.next=27;break}return e.abrupt("return");case 27:u={isWeixin:96,isDaojiaApp:95,isJDReactNativeWebView:108,isJDApp:114,isMiniProgram:107,isDJBrowser:-1},m=_index2.default.getApp().globalData&&_index2.default.getApp().globalData.mpChannel||"",m={isDaojiaApp:119,isJDReactNativeWebView:120,isDJBrowser:121,isWeixin:122,isJDApp:123,isMiniProgram:"yy_xcx"==m?203:124},y=this.getPaySource(),d=this,l=a||{},_=(0,_indexWeapp2.getStorageSync)(_indexWeapp4.LOGIN_INFO)||{},m={payToken:l&&l.payToken,redPacketPaySource:u[y],paySource:m[y],cityId:n,redPacketId:l&&l.redPacketId,openId:_.openId||"",payMode:10,successUrl:_indexWeapp.isDaojiaApp&&_indexWeapp.isAndroid?"openapp.jddj://communication/closeWeb":"https://daojia.jd.com/taroh5/h5dist/#/pages/vpayMember-t/home/index?payState=paySuccess&storeId="+i,userCardType:t},this.setState({pending:!0}),4==t&&(m.paySence=20),(0,_vpayMember.api_plus_vipPurchase)(m).then(function(e){e=e.result.payData.wechatPayVO;(0,_indexWeapp6.openPay)(e).then(function(){(0,_indexWeapp7.showToast)({title:"恭喜！您已开通会员 快去使用会员特权吧"}),o?(0,_indexWeapp2.setStorageSync)("vp_pay_success",1):setTimeout(function(){d.onGoBack()},2500),_index2.default.getApp().globalData.refreshHomeFlag=!0}).catch(function(e){e=(e||{}).msg;_index2.default.showToast({title:""+(e||"支付失败，请稍后再试~"),icon:"none",duration:2e3})}),h.setState({pending:!1})}).catch(function(e){e=(e||{}).msg;_index2.default.showToast({title:""+(e||"网络异常，请稍后再试~"),icon:"none",duration:2e3}),h.setState({pending:!1})}),y={type:p[a.cardName]||"未知"},(0,_indexWeapp3.clickReport)({create_time:new Date,click_id:"clickOpen",click_par:y});case 42:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"openVipNew",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,a,i,r,o,p,s,c,u,d,l,_,m,y=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=this.props,t=o.userCardType,t=void 0===t?"":t,n=o.btnData,i=o.storeId,a=void 0===i?"":i,i=o.goToPage,i=void 0===i?"":i,o=o.fromChannel,r=void 0===o?"":o,o={"体验卡":" expCard","月卡":"monCard","季卡":"quaCard","年卡":"yearCard","连续包月":"conMonCard"},i){if(n.buyTip)return e.next=6,this.showRenewTip();e.next=9}else e.next=14;break;case 6:if(e.sent){e.next=9;break}return e.abrupt("return");case 9:return(0,_indexWeapp7.navigateTo)(""+i),p={type:"bottom",setType:o[n.cardName]||"未知"},(0,_indexWeapp3.clickReport)({create_time:new Date,click_id:"clickMember",click_par:p}),e.abrupt("return");case 14:if(p=this.state,c=p.agreementCheck,s=p.pending,c){e.next=18;break}return(0,_indexWeapp7.showToast)({title:"请先阅读并勾选服务协议"}),e.abrupt("return");case 18:if(s&&(0,_indexWeapp7.showToast)({title:"操作太快了，休息一下吧"}),n.buyTip)return e.next=22,this.showRenewTip();e.next=25;break;case 22:if(e.sent){e.next=25;break}return e.abrupt("return");case 25:c=_index2.default.getApp().globalData&&_index2.default.getApp().globalData.mpChannel||"",m={isDaojiaApp:257,isJDReactNativeWebView:258,isDJBrowser:259,isWeixin:260,isJDApp:261,isMiniProgram:"yy_xcx"==c?265:264},u=this.getPaySource(),d=this,l=n||{},_=(0,_indexWeapp2.getStorageSync)(_indexWeapp4.LOGIN_INFO)||{},m={payToken:l&&l.payToken,paySource:m[u],redPacketId:l&&l.redPacketId,openId:_.openId||"",payMode:10,userCardType:t,fromChannel:r,pageVersion:1},this.setState({pending:!0}),4==n.userCardType&&(m.paySence=20),(0,_vpayMember.directPayFun)(m).then(function(e){var t=e.code,n=e.msg,e=e.result;"0"===t?((0,_indexWeapp2.setStorageSync)("vp_pay_success",1),(0,_indexWeapp2.getStorageSync)("vp_pay_success"),_indexWeapp.isJDReactNativeWebView&&(0,_indexWeapp2.setStorageSync)("vp_pay_success_rn",1),(_indexWeapp.isDaojiaApp||_indexWeapp.isJDApp)&&("appTab"==y.$router.params.payFrom?window.shouldPostMsgNative=1:window.returnAppLink=window.returnAppLink||"https://daojia.jd.com/taroh5/h5dist/#/pages/vpayMember-t/home/index?payState=paySuccess&storeId="+a+"&fromChannel="+r+"&channel="+r+"&reactnative="+(_indexWeapp.isJDReactNativeWebView?"jdreact":"")),_index3.paySDK.invoke(e.wechatPayVO).then(function(e){(0,_indexWeapp7.showToast)({title:"恭喜！您已开通会员 快去使用会员特权吧"}),setTimeout(function(){r?(0,_indexWeapp7.navigateTo)("/pages/vpayMember-t/home/index?payState=paySuccess&storeId="+a+"&fromChannel="+r+"&channel="+r):d.onGoBack()},2500),_index2.default.getApp().globalData.refreshHomeFlag=!0}).catch(function(e){e=(e||{}).msg;_index2.default.showToast({title:""+(e||"支付失败，请稍后再试~"),icon:"none",duration:1500})})):"1000"==t?(t=(e=void 0===(t=e.contractVo)?{}:t).businessContractCode,_index2.default.getApp().globalData.vp_entrust_pay=t,y.props.isToPageEvent(),wx.navigateToMiniProgram({appId:"wxbd687630cd02ce1d",path:"pages/index/index",extraData:JSON.parse(e.url),fail:function(e){_index2.default.showToast({title:"签约失败",icon:"none",duration:2e3})}})):_index2.default.showToast({title:n||"支付失败",icon:"none",duration:2e3}),y.setState({pending:!1}),(0,_indexWeapp3.clickReport)({page_name:"packageSelection",create_time:new Date,click_id:"clickOpen",click_par:{type:"Vplus"}})}).catch(function(e){e=e.msg||("{}"==JSON.stringify(e)?"":JSON.stringify(e)),_index2.default.showToast({title:e||"支付异常",icon:"none",duration:2e3}),y.setState({pending:!1})});case 36:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"abStrategy",value:function(){var n=this,a="B";(0,_vpayMember.abStrategyFun)().then(function(e){var t=e.code,e=(e.msg,e.result);"0"===t?(t=e&&e.cashierPayStrategyName?e.cashierPayStrategyName:"B",a=t,n.setState({isNewPayFn:a}),"B"===t&&n.props.onPayModesFun&&n.props.onPayModesFun("B")):(a="B",n.setState({isNewPayFn:a}))}).catch(function(e){a="B",n.setState({isNewPayFn:a})})}},{key:"componentWillUnmount",value:function(){this.interval&&clearInterval(this.interval)}},{key:"anonymousFunc0",value:function(e){}},{key:"anonymousFunc1",value:function(e){}},{key:"anonymousFunc2",value:function(e){}},{key:"anonymousFunc3",value:function(e){}}]),r}(),_class.$$events=["agreementCheckBtn","anonymousFunc0","anonymousFunc1","anonymousFunc2","anonymousFunc3"],_class.multipleSlots=!0,_class.$$componentPath="pages/vpayMember-t/components/bottomBtnPlusWrapNew/index",_temp2);exports.default=BottomBtnPlusWrapNew,Component(require("../../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(BottomBtnPlusWrapNew));