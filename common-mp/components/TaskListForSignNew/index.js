"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function o(e,t){for(var s=0;s<t.length;s++){var o=t[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,s){return t&&o(e.prototype,t),s&&o(e,s),e}}(),_get=function e(t,s,o){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,s);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(o):void 0:null!==(i=Object.getPrototypeOf(t))?e(i,s,o):void 0},_index=require("../../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_indexWeapp=require("../../../npm/@jd/djmp/common-t/js/taroapi/index.weapp.js"),_bean=require("../../api/bean.js"),_signIn=require("../../api/signIn.js"),_indexWeapp2=require("../../../npm/@jd/djmp/common-t/js/bi/index.weapp.js"),_utilsWeapp=require("../../../npm/@jd/djmp/common-t/js/utils/utils.weapp.js"),_indexWeapp3=require("../../../npm/@jd/djmp/common-t/js/env/index.weapp.js"),_utils=require("./js/utils.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var isWeapp=!0,SIGNIN_MODELID="M10001",secTaskIsGet=!1,REPORT={keyName:{show:"showTask",click:"click_xiandourenwu"},filterTask:function(e,t){var s=e.taskName,o=e.status,i=e.taskId,e=e.params;return{taskName:s,status:{0:"待领取任务",1:"已领取任务待完成",2:"已完成待领取奖励",3:"已完成已领取奖励"}[o],taskId:i,orgCode:e&&e.orgCode?e.orgCode:void 0,storeId:e&&e.storeId?e.storeId:void 0,taskNo:t}},show:function(){var s=this,e={taskNum:(e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:[]).map(function(e,t){return s.filterTask(e,t)})).length,tasks:e};(0,_indexWeapp2.clickReport)({click_id:this.keyName.show,click_par:e})},click:function(e){e=this.filterTask(e);(0,_indexWeapp2.clickReport)({click_id:this.keyName.click,click_par:e})},showOldTaskGuide:function(){(0,_indexWeapp2.clickReport)({click_id:"showOldTaskGuide"})}},once=!0,taskAllLists=[],showItemNums=0,v31Timer=void 0,TaskListNew=(_temp2=_class=function(){function a(){var e,t;_classCallCheck(this,a);for(var s=arguments.length,o=Array(s),i=0;i<s;i++)o[i]=arguments[i];return(e=t=_possibleConstructorReturn(this,(t=a.__proto__||Object.getPrototypeOf(a)).call.apply(t,[this].concat(o)))).$$hasLoopRef=!0,t.$usedState=["loopArray43","$compid__231","undefined","taskList","storeCouponLayer","secTaskInfo","toStoreInfo","showHand","handleTaskListDataLoaded","isOpenPushStatus","from","getOneAndMoreTasksInfo","handleGetSecTaskCallback","updateTaskInfo","getTaskListInfo","handleSuperOrderPop","setTimeRefresh","callToBottomList","callToBottomListForBack","clearTimeoutV31","router","listItemButtonBreath"],t.state={taskList:[],secTaskInfo:{},storeCouponLayer:!1,toStoreInfo:{},showHand:!1},t.customComponents=["ListItem","BrowseStoreCouponPop"],_possibleConstructorReturn(t,e)}return _inherits(a,_index.Component),_createClass(a,[{key:"_constructor",value:function(e){_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"_constructor",this).call(this,e),this.$$refs=[]}},{key:"getTaskListData",value:function(){var u=this,e=this.props,c=e.handleTaskListDataLoaded,d=e.isOpenPushStatus;(0,_bean.taskListInfo)({modelId:SIGNIN_MODELID,plateCode:(0,_utils.getPlateCode)()}).then(function(e){if(0==e.code&&e.result){for(var t=e.result||{},s=void 0===(o=t.taskInfoList)?[]:o,o=t.status,i=t.unDoneMoneyCount,t=t.showNumOnHomePage,a=!0,s=e.result.taskInfoList,n={},r=0;r<s.length&&"break"!==function(e){if(308==s[e].taskType){var t=function(){s[e].awardValue&&(i-=Number(s[e].awardValue)),s.splice(e,1)};if(!(_indexWeapp3.isDaojiaApp&&"7.4.5"<=_indexWeapp3.djAppVersion))return t(),"break";if(1==d){if(0==s[e].status)return t(),"break";1==s[e].status&&u.finnshTask(s[e],!0,!1)}}}(r);r++);0<s.length&&(a=!1);for(var p={},r=0;r<s.length;r++)if(512==s[r].taskType){0!=s[r].status&&1!=s[r].status&&2!=s[r].status||(n=s[r],0==s[r].status&&(secTaskIsGet=!0)),s.splice(r,1);break}for(var l=0;l<s.length;l++)if(513==s[l].taskType){p=s[l];break}"index"==u.props.from&&0<s.length&&t&&(s=s.filter(function(e){return 3!=e.status}),taskAllLists=[].concat(s),showItemNums=t,s=s.filter(function(e){return 0==e.isShow}).splice(0,t)),u.setState({taskList:s,secTaskInfo:n}),c(a,o,i,n,p,e.result.taskInfoList),u.v33GetTaskInfo(e.result.taskInfoList),REPORT.show(s)}}).catch(function(e){_indexWeapp3.isDaojiaApp||(0,_indexWeapp.showToast)({title:"网络繁忙，请稍后再试！"})})}},{key:"v33GetTaskInfo",value:function(e){this.props.getOneAndMoreTasksInfo&&this.props.getOneAndMoreTasksInfo(e)}},{key:"checkIsSecTaskGet",value:function(){var t=this,e=this.state.secTaskInfo;secTaskIsGet&&(secTaskIsGet=!1,setTimeout(function(){(0,_bean.receivedTaskInfo)({modelId:SIGNIN_MODELID,taskId:e.taskId,taskType:e.taskType,plateCode:(0,_utils.getPlateCode)()}).then(function(e){0==e.code&&(t.getTaskListInfo(!0),t.props.handleGetSecTaskCallback())}).catch(function(e){t.getTaskListInfo(!0)})},200))}},{key:"getTaskListInfo",value:function(e){this.getTaskListData()}},{key:"finnshTask",value:function(e,t,s){var o=this;(0,_bean.finishedTaskInfo)({modelId:SIGNIN_MODELID,taskId:e.taskId,taskType:e.taskType,plateCode:(0,_utils.getPlateCode)()}).then(function(e){t&&(o.getTaskListInfo(s),o.props.updateTaskInfo&&o.props.updateTaskInfo())}).catch(function(e){t&&o.getTaskListInfo(s)})}},{key:"finishTaskForStore",value:function(e){this.finnshTask(e,!0,!1)}},{key:"getReward",value:function(e,t){var s=this;(0,_bean.sendTaskPrizeInfo)({modelId:SIGNIN_MODELID,taskId:e,taskType:t,plateCode:(0,_utils.getPlateCode)()}).then(function(e){0==e.code?(e.result&&e.result.awardValue&&(0,_indexWeapp.showToast)({title:"成功收取"+e.result.awardValue+"鲜豆"}),s.getTaskListInfo(!1)):(s.getTaskListInfo(!1),(0,_indexWeapp.showToast)({title:"网络开小差了，请稍后重试"}))}).catch(function(e){(0,_indexWeapp.showToast)({title:"网络开小差了，请稍后重试"}),s.props.getTaskListInfo(!1)})}},{key:"checkTimeB",value:function(){var e,t=(0,_utils.getTaskBrowseTime)();t&&((0,_utils.checkTaskBrowseTime)()?(e=void 0,e="string"==typeof t?JSON.parse(t):JSON.parse(JSON.stringify(t)),this.finishTaskForStore(e.info)):_index2.default.showToast({title:"时间太短啦~",icon:"none",duration:3e3}),(0,_utils.resetTaskBrowseTime)())}},{key:"updateListData",value:function(e){var t=this;taskAllLists&&taskAllLists.splice&&taskAllLists.splice(e,1);e=(e=[].concat(taskAllLists)).splice(0,showItemNums);this.setState({taskList:e},function(){t.getTaskListInfo()}),this.v33GetTaskInfo(e)}},{key:"getRewardAnimate",value:function(e){this["childTaskItem"+e]&&this["childTaskItem"+e].setAnimate()}},{key:"handleSuperOrderPops",value:function(){this.props.handleSuperOrderPop()}},{key:"closeCouponLayer",value:function(){this.setState({storeCouponLayer:!1})}},{key:"handleToStore",value:function(e){this.setState({storeCouponLayer:!0,toStoreInfo:e});e=e.params;(0,_indexWeapp2.clickReport)({click_id:"showGoStoreCouponPopup",click_par:{orgCode:e&&e.orgCode?e.orgCode:void 0,storeId:e&&e.storeId?e.storeId:void 0}})}},{key:"setTimeRefresh",value:function(){this.props.setTimeRefresh()}},{key:"callToBottomList",value:function(){this.props.callToBottomList&&this.props.callToBottomList("task",0<arguments.length&&void 0!==arguments[0]?arguments[0]:{})}},{key:"refreshbCallInDjApp",value:function(){var e=this;_indexWeapp3.isDaojiaApp&&(_indexWeapp3.isAndroid&&(window.djAppDidBecomeActive=function(){e.checkTimeB(),e.props.callToBottomListForBack&&e.props.callToBottomListForBack()}),_indexWeapp3.isIOS&&(window.djWebviewRefresh=function(){e.checkTimeB(),e.props.callToBottomListForBack&&e.props.callToBottomListForBack()}))}},{key:"clearTimeoutV31",value:function(){this.props&&this.props.clearTimeoutV31&&this.props.clearTimeoutV31()}},{key:"componentWillMount",value:function(){var s=this;(0,_signIn.getShareInfoBySceneFn)().then(function(e){var t;0==e.code&&e.result&&(t=(e=e.result).mpShareTitle,e=e.mpShareImg,s.setState({shareInfo:{title:t,shareUrl:e,shareText:t}}))}).catch(function(e){})}},{key:"componentDidMount",value:function(){var e=this,t=this.props.router&&this.props.router.params,s=t&&t.taskId,t=t&&t.taskType;t&&this.finnshTask({taskId:s||"",taskType:t||""},!0,!1),this.refreshbCallInDjApp(),(0,_utilsWeapp.isQueryCheck)("showhand","1")&&(v31Timer=setTimeout(function(){e.setState({showHand:!0}),REPORT.showOldTaskGuide()},3e3))}},{key:"clearTimeoutV31",value:function(){clearTimeout(v31Timer),this.setState({showHand:!1})}},{key:"_createData",value:function(){var a=this,n=(this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{},arguments[2]),r=this.$prefix,e=(0,_index.genCompid)(r+"$compid__231"),p=this.$scope,t=this.__state,l=t.taskList,u=t.shareInfo,s=t.storeCouponLayer,o=t.toStoreInfo,c=t.showHand,t=this.__props,d=t.isOpenPushStatus,h=t.from,f=t.listItemButtonBreath,t=0<l.length?l.map(function(e,t){e={$original:(0,_index.internal_get_original)(e)};var s=!(0<l.length)||-1==e.$original.isShow||null!=e.$original.showPosition&&1!=e.$original.showPosition?null:"jBcoR"+t,o=p&&n&&(0,_index.getElementById)(p,"#jBcoR"+t,"component"),i=(0,_index.genCompid)(r+"hGPdaGWlhN"+t);return-1==e.$original.isShow||null!=e.$original.showPosition&&1!=e.$original.showPosition||_index.propsManager.set({from:h,item:e.$original,index:t,shareInfo:u,isOpenPushStatus:d,showHand:c,handleSuperOrderPops:a.handleSuperOrderPops.bind(a),updateListData:a.updateListData.bind(a),getTaskListInfo:a.getTaskListInfo.bind(a),handleToStore:a.handleToStore.bind(a),isRewardBreath:f,callToBottomList:a.callToBottomList.bind(a),clearTimeoutV31:a.clearTimeoutV31.bind(a)},i),o&&(a["childTaskItem"+t]=o),{$loopState__temp2:s,$compid__230:i,$original:e.$original}}):[];return s&&_index.propsManager.set({taskInfo:o,closeCouponLayer:this.closeCouponLayer.bind(this),setTimeRefresh:this.setTimeRefresh.bind(this),finishTaskForStore:this.finishTaskForStore.bind(this)},e),Object.assign(this.__state,{loopArray43:t,$compid__231:e,undefined:void 0}),this.__state}}]),a}(),_class.$$events=[],_class.$$componentPath="common-mp/components/TaskListForSignNew/index",_temp2);exports.default=TaskListNew,Component(require("../../../npm/@tarojs/taro-weapp/index.js").default.createComponent(TaskListNew));